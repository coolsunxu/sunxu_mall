# 苏三商城后端完整实现文档

> 作者：苏三  
> 项目：苏三商城  
> 创建时间：2025年

---

## 一、项目概述

### 1.1 项目简介

苏三商城是一个基于Spring Boot + Vue2的前后端分离的电商管理系统。后端采用Spring Cloud微服务架构，使用MyBatis-Plus作为ORM框架，集成XXL-JOB定时任务、RabbitMQ消息队列、WebSocket实时通信等技术。

### 1.2 技术栈

| 层级 | 技术选型 |
|------|----------|
| 核心框架 | Spring Boot 2.7.x |
| 微服务 | Spring Cloud Alibaba |
| ORM框架 | MyBatis-Plus 3.5.x |
| 数据库 | MySQL 8.0 |
| 缓存 | Redis |
| 消息队列 | RabbitMQ |
| 定时任务 | XXL-JOB |
| 对象存储 | MinIO/七牛云 |
| 支付 | 支付宝 |
| 短信 | 阿里云短信 |
| 搜索引擎 | Elasticsearch |

### 1.3 项目结构

```
susan_mall/
├── mall-common/          # 公共模块（实体、工具类、异常处理）
├── mall-business/        # 业务模块（Service层实现）
├── mall-mgt/            # 管理后台API（Controller层）
├── mall-job/            # 定时任务模块
├── susan_mall_web/      # 前端Vue项目
└── sql/                 # 数据库脚本
```

---

## 二、基础架构搭建

### 2.1 数据库初始化

执行SQL脚本创建表结构和初始化数据：

```sql
-- 创建表结构
source sql/create_table_*.sql

-- 初始化数据
source sql/init_data_*.sql

-- 更新表结构（特性版本）
source sql/feature_*.sql
```

### 2.2 API响应格式规范

#### 成功响应

```json
{
  "code": 200,
  "data": {
    "total": 100,
    "size": 10,
    "current": 1,
    "records": [...]
  },
  "msg": "操作成功"
}
```

#### 错误响应

```json
{
  "code": 500,
  "data": null,
  "msg": "错误信息"
}
```

### 2.3 Maven依赖配置

```xml
<!-- mall-common/pom.xml -->
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
        <version>3.5.3.1</version>
    </dependency>
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <scope>runtime</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    <dependency>
        <groupId>cn.hutool</groupId>
        <artifactId>hutool-all</artifactId>
        <version>5.8.18</version>
    </dependency>
</dependencies>
```

---

## 三、核心业务模块（P0优先级）

### 3.1 用户认证与权限模块

#### 3.1.1 数据库表结构

```sql
-- 用户表
CREATE TABLE `sys_user` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(100) NOT NULL COMMENT '密码(加密)',
  `nick_name` varchar(50) DEFAULT NULL COMMENT '昵称',
  `phone` varchar(11) DEFAULT NULL COMMENT '手机号',
  `email` varchar(50) DEFAULT NULL COMMENT '邮箱',
  `avatar` varchar(200) DEFAULT NULL COMMENT '头像',
  `dept_id` bigint DEFAULT NULL COMMENT '部门ID',
  `job_id` bigint DEFAULT NULL COMMENT '岗位ID',
  `sex` char(1) DEFAULT NULL COMMENT '性别',
  `is_del` tinyint DEFAULT 0 COMMENT '是否删除',
  `create_user_id` bigint DEFAULT NULL COMMENT '创建人ID',
  `create_user_name` varchar(50) DEFAULT NULL COMMENT '创建人姓名',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_user_id` bigint DEFAULT NULL COMMENT '修改人ID',
  `update_user_name` varchar(50) DEFAULT NULL COMMENT '修改人姓名',
  `update_time` datetime DEFAULT NULL COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- 用户角色关联表
CREATE TABLE `sys_user_role` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `role_id` bigint NOT NULL COMMENT '角色ID',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';

-- 角色表
CREATE TABLE `sys_role` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '角色名称',
  `code` varchar(50) NOT NULL COMMENT '角色编码',
  `description` varchar(100) DEFAULT NULL COMMENT '角色描述',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';

-- 角色菜单关联表
CREATE TABLE `sys_role_menu` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `role_id` bigint NOT NULL COMMENT '角色ID',
  `menu_id` bigint NOT NULL COMMENT '菜单ID',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色菜单关联表';

-- 菜单表
CREATE TABLE `sys_menu` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `parent_id` bigint DEFAULT 0 COMMENT '父级ID',
  `name` varchar(50) NOT NULL COMMENT '菜单名称',
  `type` tinyint DEFAULT 1 COMMENT '类型：1-目录，2-菜单，3-按钮',
  `path` varchar(100) DEFAULT NULL COMMENT '路由路径',
  `component` varchar(200) DEFAULT NULL COMMENT '组件路径',
  `icon` varchar(50) DEFAULT NULL COMMENT '图标',
  `sort` int DEFAULT 0 COMMENT '排序',
  `is_visible` tinyint DEFAULT 1 COMMENT '是否显示：0-隐藏，1-显示',
  `permission` varchar(100) DEFAULT NULL COMMENT '权限标识',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='菜单表';

-- 部门表
CREATE TABLE `sys_dept` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `parent_id` bigint DEFAULT 0 COMMENT '父级ID',
  `name` varchar(50) NOT NULL COMMENT '部门名称',
  `sort` int DEFAULT 0 COMMENT '排序',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部门表';

-- 岗位表
CREATE TABLE `sys_job` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '岗位名称',
  `sort` int DEFAULT 0 COMMENT '排序',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-停用，1-启用',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='岗位表';

-- 字典表
CREATE TABLE `sys_dict` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '字典名称',
  `type` varchar(50) NOT NULL COMMENT '字典类型',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_type` (`type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='字典表';

-- 字典详情表
CREATE TABLE `sys_dict_detail` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `dict_id` bigint NOT NULL COMMENT '字典ID',
  `label` varchar(100) NOT NULL COMMENT '字典标签',
  `value` varchar(100) NOT NULL COMMENT '字典值',
  `sort` int DEFAULT 0 COMMENT '排序',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='字典详情表';
```

#### 3.1.2 实体类定义

```java
// UserEntity.java
@Data
@TableName("sys_user")
public class UserEntity extends BaseEntity {

    @TableId(type = IdType.ASSIGN_ID)
    private Long id;

    @ExcelProperty(value = "用户名", index = 0)
    private String username;

    private String password;

    @ExcelProperty(value = "昵称", index = 1)
    private String nickName;

    @ExcelProperty(value = "手机号", index = 2)
    private String phone;

    private String email;

    private String avatar;

    private Long deptId;

    private Long jobId;

    private String sex;

    // 关联字段（不存入数据库）
    @TableField(exist = false)
    private String roleNames;
}
```

#### 3.1.3 Mapper层实现

```java
// UserMapper.java
@Mapper
public interface UserMapper extends BaseMapper<UserEntity> {
    
    // 条件查询
    List<UserEntity> searchByCondition(@Param("condition") UserConditionEntity condition);
    
    // 条件统计
    int searchCount(@Param("condition") UserConditionEntity condition);
    
    // 根据用户名查询
    UserEntity findByUsername(@Param("username") String username);
}
```

```xml
<!-- UserMapper.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.net.susan.mapper.sys.UserMapper">

    <resultMap id="BaseResultMap" type="cn.net.susan.entity.sys.UserEntity">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="password" property="password"/>
        <result column="nick_name" property="nickName"/>
        <result column="phone" property="phone"/>
        <result column="email" property="email"/>
        <result column="avatar" property="avatar"/>
        <result column="dept_id" property="deptId"/>
        <result column="job_id" property="jobId"/>
        <result column="sex" property="sex"/>
        <result column="is_del" property="isDel"/>
        <result column="create_user_id" property="createUserId"/>
        <result column="create_user_name" property="createUserName"/>
        <result column="create_time" property="createTime"/>
        <result column="update_user_id" property="updateUserId"/>
        <result column="update_user_name" property="updateUserName"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, username, password, nick_name, phone, email, avatar, dept_id, job_id, sex, 
        is_del, create_user_id, create_user_name, create_time, update_user_id, update_user_name, update_time
    </sql>

    <!-- 条件查询 -->
    <select id="searchByCondition" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        <where>
            <if test="condition.username != null and condition.username != ''">
                AND username LIKE CONCAT('%', #{condition.username}, '%')
            </if>
            <if test="condition.nickName != null and condition.nickName != ''">
                AND nick_name LIKE CONCAT('%', #{condition.nickName}, '%')
            </if>
            <if test="condition.deptId != null">
                AND dept_id = #{condition.deptId}
            </if>
            <if test="condition.jobId != null">
                AND job_id = #{condition.jobId}
            </if>
            <if test="condition.sex != null and condition.sex != ''">
                AND sex = #{condition.sex}
            </if>
            <if test="condition.createBeginTime != null">
                AND create_time >= #{condition.createBeginTime}
            </if>
            <if test="condition.createEndTime != null">
                AND create_time &lt;= #{condition.createEndTime}
            </if>
            AND is_del = 0
        </where>
        ORDER BY create_time DESC
        <if test="offset != null and offset >= 0">
            LIMIT #{offset}, #{size}
        </if>
    </select>

    <!-- 条件统计 -->
    <select id="searchCount" resultType="int">
        SELECT COUNT(*)
        FROM sys_user
        <where>
            <if test="condition.username != null and condition.username != ''">
                AND username LIKE CONCAT('%', #{condition.username}, '%')
            </if>
            AND is_del = 0
        </where>
    </select>

</mapper>
```

#### 3.1.4 Service层实现

```java
// UserService.java
public interface UserService extends BaseService<UserConditionEntity, UserEntity> {

    /**
     * 根据用户名查询用户
     */
    UserEntity findByUsername(String username);

    /**
     * 用户登录
     */
    TokenEntity login(LoginRequest request);

    /**
     * 修改密码
     */
    void updatePassword(Long userId, String oldPassword, String newPassword);

    /**
     * 重置密码
     */
    void resetPassword(List<Long> ids);

    /**
     * 分配角色
     */
    void assignRoles(Long userId, List<Long> roleIds);
}
```

```java
// UserServiceImpl.java
@Service
@Slf4j
public class UserServiceImpl extends BaseServiceImpl<UserConditionEntity, UserEntity> implements UserService {

    @Autowired
    private UserMapper userMapper;

    @Autowired
    private UserRoleService userRoleService;

    @Autowired
    private PasswordUtil passwordUtil;

    @Autowired
    private TokenUtil tokenUtil;

    @Autowired
    private RedisUtil redisUtil;

    @Override
    public UserEntity findByUsername(String username) {
        return userMapper.findByUsername(username);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public TokenEntity login(LoginRequest request) {
        // 1. 验证码校验
        validateCaptcha(request.getUuid(), request.getCode());

        // 2. 根据用户名查询用户
        UserEntity user = findByUsername(request.getUsername());
        if (user == null) {
            throw new BusinessException("用户名或密码错误");
        }

        // 3. 密码校验
        String encryptPassword = passwordUtil.encrypt(request.getPassword());
        if (!encryptPassword.equals(user.getPassword())) {
            throw new BusinessException("用户名或密码错误");
        }

        // 4. 生成Token
        TokenEntity token = tokenUtil.generateToken(user);

        // 5. 更新登录信息
        user.setLoginTime(new Date());
        userMapper.update(user);

        return token;
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void updatePassword(Long userId, String oldPassword, String newPassword) {
        UserEntity user = userMapper.selectById(userId);
        if (user == null) {
            throw new BusinessException("用户不存在");
        }

        // 验证旧密码
        String oldEncryptPassword = passwordUtil.encrypt(oldPassword);
        if (!oldEncryptPassword.equals(user.getPassword())) {
            throw new BusinessException("原密码错误");
        }

        // 设置新密码
        user.setPassword(passwordUtil.encrypt(newPassword));
        userMapper.update(user);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void resetPassword(List<Long> ids) {
        String defaultPassword = "123456";
        String encryptPassword = passwordUtil.encrypt(defaultPassword);

        for (Long id : ids) {
            UserEntity user = new UserEntity();
            user.setId(id);
            user.setPassword(encryptPassword);
            userMapper.update(user);
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void assignRoles(Long userId, List<Long> roleIds) {
        // 1. 删除原有角色关联
        userRoleService.deleteByUserId(userId);

        // 2. 新增角色关联
        for (Long roleId : roleIds) {
            UserRoleEntity userRole = new UserRoleEntity();
            userRole.setUserId(userId);
            userRole.setRoleId(roleId);
            userRoleService.insert(userRole);
        }
    }

    private void validateCaptcha(String uuid, String code) {
        String captchaKey = CaptchaKeyUtil.getCaptchaKey(uuid);
        String redisCode = redisUtil.get(captchaKey);
        if (StringUtils.isEmpty(redisCode) || !redisCode.equalsIgnoreCase(code)) {
            throw new BusinessException("验证码错误");
        }
        redisUtil.del(captchaKey);
    }
}
```

#### 3.1.5 Controller层实现

```java
// UserController.java
@RestController
@RequestMapping("/v1/user")
@Api(tags = "用户管理")
public class UserController {

    @Autowired
    private UserService userService;

    @NoLogin
    @ApiOperation(notes = "分页查询用户", value = "分页查询用户")
    @PostMapping("/searchByPage")
    public ApiResult<PageData<UserEntity>> searchByPage(@RequestBody UserConditionEntity condition) {
        List<UserEntity> list = userService.searchByCondition(condition);
        int count = userService.searchCount(condition);
        return ApiResultUtil.success(PageData.of(count, list));
    }

    @NoLogin
    @ApiOperation(notes = "查询用户详情", value = "查询用户详情")
    @GetMapping("/findById")
    public ApiResult<UserEntity> findById(@RequestParam Long id) {
        UserEntity user = userService.findById(id);
        return ApiResultUtil.success(user);
    }

    @NoLogin
    @ApiOperation(notes = "新增用户", value = "新增用户")
    @PostMapping("/insert")
    public ApiResult<Void> insert(@RequestBody UserEntity user) {
        userService.insert(user);
        return ApiResultUtil.success();
    }

    @NoLogin
    @ApiOperation(notes = "修改用户", value = "修改用户")
    @PostMapping("/update")
    public ApiResult<Void> update(@RequestBody UserEntity user) {
        userService.update(user);
        return ApiResultUtil.success();
    }

    @NoLogin
    @ApiOperation(notes = "删除用户", value = "删除用户")
    @PostMapping("/deleteByIds")
    public ApiResult<Void> deleteByIds(@RequestBody List<Long> ids) {
        userService.deleteByIds(ids);
        return ApiResultUtil.success();
    }

    @NoLogin
    @ApiOperation(notes = "修改密码", value = "修改密码")
    @PostMapping("/updatePass")
    public ApiResult<Void> updatePass(@RequestBody UpdatePassRequest request) {
        userService.updatePassword(UserContext.getCurrentUserId(), request.getOldPass(), request.getNewPass());
        return ApiResultUtil.success();
    }

    @NoLogin
    @ApiOperation(notes = "重置密码", value = "重置密码")
    @PostMapping("/resetPwd")
    public ApiResult<Void> resetPwd(@RequestBody List<Long> ids) {
        userService.resetPassword(ids);
        return ApiResultUtil.success();
    }

    @NoLogin
    @ExcelExport(ExcelBizTypeEnum.USER)
    @ApiOperation(notes = "导出用户", value = "导出用户")
    @PostMapping("/export")
    public void export(HttpServletResponse response, UserConditionEntity condition) {
        // 由AOP切面处理导出逻辑
    }
}
```

#### 3.1.6 认证相关API

```java
// WebUserController.java
@RestController
@RequestMapping("/v1/web/user")
public class WebUserController {

    @Autowired
    private UserService userService;

    @NoLogin
    @PostMapping("/login")
    @ApiOperation(notes = "用户登录", value = "用户登录")
    public ApiResult<TokenEntity> login(@RequestBody LoginRequest request) {
        TokenEntity token = userService.login(request);
        return ApiResultUtil.success(token);
    }

    @GetMapping("/info")
    @ApiOperation(notes = "获取当前用户信息", value = "获取当前用户信息")
    public ApiResult<JwtUserEntity> getInfo() {
        JwtUserEntity user = (JwtUserEntity) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        return ApiResultUtil.success(user);
    }

    @GetMapping("/code")
    @NoLogin
    @ApiOperation(notes = "获取验证码图片", value = "获取验证码图片")
    public void getCodeImg(HttpServletResponse response, HttpSession session) {
        String captcha = CaptchaUtil.generateCode();
        String uuid = UUID.randomUUID().toString();
        
        String captchaKey = CaptchaKeyUtil.getCaptchaKey(uuid);
        redisUtil.set(captchaKey, captcha, 300);
        
        BufferedImage image = CaptchaUtil.generateImage(captcha);
        ServletOutputStream outputStream = response.getOutputStream();
        ImageIO.write(image, "png", outputStream);
    }

    @NoLogin
    @PostMapping("/logout")
    @ApiOperation(notes = "退出登录", value = "退出登录")
    public ApiResult<Void> logout() {
        String token = RequestUtil.getToken();
        tokenUtil.deleteToken(token);
        return ApiResultUtil.success();
    }
}
```

#### 3.1.7 前端API调用示例

```javascript
// user.js
import request from '@/utils/request'
import { encrypt } from '@/utils/rsaEncrypt'

export function add(data) {
  return request({
    url: 'v1/user/insert',
    method: 'post',
    data
  })
}

export function del(ids) {
  return request({
    url: 'v1/user/deleteByIds',
    method: 'post',
    data: ids
  })
}

export function edit(data) {
  return request({
    url: 'v1/user/update',
    method: 'post',
    data
  })
}

export function updatePass(user) {
  const data = {
    oldPass: encrypt(user.oldPass),
    newPass: encrypt(user.newPass)
  }
  return request({
    url: 'v1/user/updatePass/',
    method: 'post',
    data
  })
}

export function resetPwd(ids) {
  return request({
    url: 'v1/user/resetPwd',
    method: 'post',
    data: ids
  })
}

export default { add, edit, del, resetPwd }
```

```javascript
// login.js
import request from '@/utils/request'

export function login(username, password, code, uuid) {
  return request({
    url: '/v1/web/user/login',
    method: 'post',
    data: {
      username,
      password,
      code,
      uuid
    }
  })
}

export function getInfo() {
  return request({
    url: '/v1/web/user/info',
    method: 'get'
  })
}

export function getCodeImg() {
  return request({
    url: '/v1/web/user/code',
    method: 'get'
  })
}

export function logout() {
  return request({
    url: '/v1/web/user/logout',
    method: 'post'
  })
}
```

---

### 3.2 商品与商城管理模块

#### 3.2.1 数据库表结构

```sql
-- 商品表
CREATE TABLE `mall_product` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '商品ID',
  `name` varchar(100) NOT NULL COMMENT '商品名称',
  `sub_name` varchar(200) DEFAULT NULL COMMENT '副标题',
  `product_no` varchar(50) DEFAULT NULL COMMENT '商品编号',
  `brand_id` bigint DEFAULT NULL COMMENT '品牌ID',
  `category_id` bigint DEFAULT NULL COMMENT '分类ID',
  `unit_id` bigint DEFAULT NULL COMMENT '单位ID',
  `price` decimal(10,2) NOT NULL COMMENT '价格',
  `cost_price` decimal(10,2) DEFAULT NULL COMMENT '成本价',
  `stock` int DEFAULT 0 COMMENT '库存',
  `low_stock` int DEFAULT 0 COMMENT '预警库存',
  `photo` varchar(500) DEFAULT NULL COMMENT '主图',
  `photo_group_id` bigint DEFAULT NULL COMMENT '图片组ID',
  `description` text COMMENT '商品描述',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-下架，1-上架',
  `is_del` tinyint DEFAULT 0,
  `create_user_id` bigint DEFAULT NULL,
  `create_user_name` varchar(50) DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  `update_user_id` bigint DEFAULT NULL,
  `update_user_name` varchar(50) DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品表';

-- 商品属性表
CREATE TABLE `mall_attribute` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '属性名称',
  `category_id` bigint NOT NULL COMMENT '分类ID',
  `select_type` tinyint DEFAULT 1 COMMENT '选择类型：1-单选，2-多选',
  `input_type` tinyint DEFAULT 1 COMMENT '输入类型：1-手工录入，2-从列表选择',
  `input_list` varchar(500) DEFAULT NULL COMMENT '可选值列表',
  `sort` int DEFAULT 0 COMMENT '排序',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品属性表';

-- 分类表
CREATE TABLE `mall_category` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '分类名称',
  `parent_id` bigint DEFAULT 0 COMMENT '父级ID',
  `level` int DEFAULT 1 COMMENT '层级',
  `sort` int DEFAULT 0 COMMENT '排序',
  `photo` varchar(200) DEFAULT NULL COMMENT '分类图片',
  `is_show` tinyint DEFAULT 1 COMMENT '是否显示',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品分类表';

-- 品牌表
CREATE TABLE `mall_brand` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '品牌名称',
  `first_char` char(1) DEFAULT NULL COMMENT '首字母',
  `logo` varchar(200) DEFAULT NULL COMMENT '品牌logo',
  `story` text COMMENT '品牌故事',
  `sort` int DEFAULT 0 COMMENT '排序',
  `is_show` tinyint DEFAULT 1 COMMENT '是否显示',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='品牌表';

-- 单位表
CREATE TABLE `mall_unit` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '单位名称',
  `sort` int DEFAULT 0 COMMENT '排序',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='单位表';

-- 商品评价表
CREATE TABLE `mall_product_comment` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `product_id` bigint NOT NULL COMMENT '商品ID',
  `order_id` bigint NOT NULL COMMENT '订单ID',
  `score` tinyint NOT NULL COMMENT '评分：1-5',
  `content` varchar(500) DEFAULT NULL COMMENT '评价内容',
  `photo` varchar(500) DEFAULT NULL COMMENT '评价图片',
  `is_show` tinyint DEFAULT 1 COMMENT '是否显示',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品评价表';
```

#### 3.2.2 实体类定义

```java
// ProductEntity.java
@Data
@TableName("mall_product")
public class ProductEntity extends BaseEntity {

    @TableId(type = IdType.ASSIGN_ID)
    private Long id;

    @ExcelProperty(value = "商品名称", index = 0)
    private String name;

    private String subName;

    private String productNo;

    private Long brandId;

    private Long categoryId;

    private Long unitId;

    @ExcelProperty(value = "价格", index = 1)
    private BigDecimal price;

    private BigDecimal costPrice;

    private Integer stock;

    private Integer lowStock;

    private String photo;

    private Long photoGroupId;

    private String description;

    private Integer status;

    // 关联字段
    @TableField(exist = false)
    private String brandName;

    @TableField(exist = false)
    private String categoryName;

    @TableField(exist = false)
    private String unitName;
}
```

#### 3.2.3 Service层实现

```java
// ProductService.java
public interface ProductService extends BaseService<ProductConditionEntity, ProductEntity> {

    /**
     * 商品上架
     */
    void onSale(List<Long> ids);

    /**
     * 商品下架
     */
    void offSale(List<Long> ids);

    /**
     * 库存扣减
     */
    void reduceStock(Long productId, Integer count);

    /**
     * 库存增加
     */
    void addStock(Long productId, Integer count);
}
```

```java
// ProductServiceImpl.java
@Service
@Slf4j
public class ProductServiceImpl extends BaseServiceImpl<ProductConditionEntity, ProductEntity> implements ProductService {

    @Autowired
    private ProductMapper productMapper;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void onSale(List<Long> ids) {
        for (Long id : ids) {
            ProductEntity product = productMapper.selectById(id);
            if (product == null) {
                throw new BusinessException("商品不存在: " + id);
            }
            product.setStatus(1); // 上架
            productMapper.update(product);
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void offSale(List<Long> ids) {
        for (Long id : ids) {
            ProductEntity product = productMapper.selectById(id);
            if (product == null) {
                throw new BusinessException("商品不存在: " + id);
            }
            product.setStatus(0); // 下架
            productMapper.update(product);
        }
    }

    @Override
    @Lock(name = "product_stock_lock")
    @Transactional(rollbackFor = Exception.class)
    public void reduceStock(Long productId, Integer count) {
        ProductEntity product = productMapper.selectById(productId);
        if (product == null) {
            throw new BusinessException("商品不存在");
        }
        if (product.getStock() < count) {
            throw new BusinessException("库存不足");
        }
        product.setStock(product.getStock() - count);
        productMapper.update(product);
    }

    @Override
    @Lock(name = "product_stock_lock")
    @Transactional(rollbackFor = Exception.class)
    public void addStock(Long productId, Integer count) {
        ProductEntity product = productMapper.selectById(productId);
        if (product == null) {
            throw new BusinessException("商品不存在");
        }
        product.setStock(product.getStock() + count);
        productMapper.update(product);
    }
}
```

#### 3.2.4 Controller层实现

```java
// ProductController.java
@RestController
@RequestMapping("/v1/product")
@Api(tags = "商品管理")
public class ProductController {

    @Autowired
    private ProductService productService;

    @PostMapping("/searchByPage")
    @ApiOperation(notes = "分页查询商品", value = "分页查询商品")
    public ApiResult<PageData<ProductEntity>> searchByPage(@RequestBody ProductConditionEntity condition) {
        List<ProductEntity> list = productService.searchByCondition(condition);
        int count = productService.searchCount(condition);
        return ApiResultUtil.success(PageData.of(count, list));
    }

    @GetMapping("/findById")
    @ApiOperation(notes = "查询商品详情", value = "查询商品详情")
    public ApiResult<ProductEntity> findById(@RequestParam Long id) {
        ProductEntity product = productService.findById(id);
        return ApiResultUtil.success(product);
    }

    @PostMapping("/insert")
    @ApiOperation(notes = "新增商品", value = "新增商品")
    public ApiResult<Void> insert(@RequestBody ProductEntity product) {
        productService.insert(product);
        return ApiResultUtil.success();
    }

    @PostMapping("/update")
    @ApiOperation(notes = "修改商品", value = "修改商品")
    public ApiResult<Void> update(@RequestBody ProductEntity product) {
        productService.update(product);
        return ApiResultUtil.success();
    }

    @PostMapping("/deleteByIds")
    @ApiOperation(notes = "删除商品", value = "删除商品")
    public ApiResult<Void> deleteByIds(@RequestBody List<Long> ids) {
        productService.deleteByIds(ids);
        return ApiResultUtil.success();
    }

    @PostMapping("/onSale")
    @ApiOperation(notes = "商品上架", value = "商品上架")
    public ApiResult<Void> onSale(@RequestBody List<Long> ids) {
        productService.onSale(ids);
        return ApiResultUtil.success();
    }

    @PostMapping("/offSale")
    @ApiOperation(notes = "商品下架", value = "商品下架")
    public ApiResult<Void> offSale(@RequestBody List<Long> ids) {
        productService.offSale(ids);
        return ApiResultUtil.success();
    }
}
```

#### 3.2.5 前端API调用

```javascript
// product.js
import request from '@/utils/request'

export function getPage(params) {
  const data = params
  return request({
    url: '/v1/product/searchByPage',
    method: 'post',
    data
  })
}

export function getDetail(id) {
  return request({
    url: 'v1/product/findById?id=' + id,
    method: 'get'
  })
}

export function add(data) {
  return request({
    url: 'v1/product/insert',
    method: 'post',
    data
  })
}

export function del(ids) {
  return request({
    url: 'v1/product/deleteByIds',
    method: 'post',
    data: ids
  })
}

export function edit(data) {
  return request({
    url: 'v1/product/update',
    method: 'post',
    data
  })
}

export default { add, edit, del, getDetail, getPage }
```

---

### 3.3 订单管理模块

#### 3.3.1 数据库表结构

```sql
-- 订单表
CREATE TABLE `ord_trade` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `trade_no` varchar(50) NOT NULL COMMENT '订单编号',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `total_amount` decimal(12,2) NOT NULL COMMENT '订单总额',
  `pay_amount` decimal(12,2) DEFAULT 0.00 COMMENT '实付金额',
  `freight_amount` decimal(10,2) DEFAULT 0.00 COMMENT '运费',
  `discount_amount` decimal(10,2) DEFAULT 0.00 COMMENT '优惠金额',
  `status` tinyint DEFAULT 0 COMMENT '订单状态：0-待付款，1-已付款，2-已发货，3-已完成，4-已取消',
  `pay_type` tinyint DEFAULT NULL COMMENT '支付方式：1-支付宝，2-微信',
  `pay_time` datetime DEFAULT NULL COMMENT '支付时间',
  `consign_time` datetime DEFAULT NULL COMMENT '发货时间',
  `finish_time` datetime DEFAULT NULL COMMENT '完成时间',
  `consignee_name` varchar(50) NOT NULL COMMENT '收货人姓名',
  `consignee_phone` varchar(20) NOT NULL COMMENT '收货人电话',
  `consignee_address` varchar(200) NOT NULL COMMENT '收货人地址',
  `remark` varchar(200) DEFAULT NULL COMMENT '备注',
  `is_del` tinyint DEFAULT 0,
  `create_user_id` bigint DEFAULT NULL,
  `create_user_name` varchar(50) DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  `update_user_id` bigint DEFAULT NULL,
  `update_user_name` varchar(50) DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_trade_no` (`trade_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';

-- 订单项表
CREATE TABLE `ord_trade_item` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `trade_id` bigint NOT NULL COMMENT '订单ID',
  `product_id` bigint NOT NULL COMMENT '商品ID',
  `product_name` varchar(100) NOT NULL COMMENT '商品名称',
  `product_photo` varchar(200) DEFAULT NULL COMMENT '商品图片',
  `product_price` decimal(10,2) NOT NULL COMMENT '商品价格',
  `product_count` int NOT NULL COMMENT '商品数量',
  `product_total_price` decimal(10,2) NOT NULL COMMENT '商品总价',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单项表';

-- 订单状态枚举
-- 0-待付款, 1-已付款, 2-已发货, 3-已完成, 4-已取消, 5-已退款
```

#### 3.3.2 实体类定义

```java
// TradeEntity.java
@Data
@TableName("ord_trade")
public class TradeEntity extends BaseEntity {

    @TableId(type = IdType.ASSIGN_ID)
    private Long id;

    private String tradeNo;

    private Long userId;

    private BigDecimal totalAmount;

    private BigDecimal payAmount;

    private BigDecimal freightAmount;

    private BigDecimal discountAmount;

    private Integer status;

    private Integer payType;

    private Date payTime;

    private Date consignTime;

    private Date finishTime;

    private String consigneeName;

    private String consigneePhone;

    private String consigneeAddress;

    private String remark;

    // 关联字段
    @TableField(exist = false)
    private List<TradeItemEntity> items;
}

// TradeItemEntity.java
@Data
@TableName("ord_trade_item")
public class TradeItemEntity extends BaseEntity {

    @TableId(type = IdType.ASSIGN_ID)
    private Long id;

    private Long tradeId;

    private Long productId;

    private String productName;

    private String productPhoto;

    private BigDecimal productPrice;

    private Integer productCount;

    private BigDecimal productTotalPrice;
}
```

#### 3.3.3 Service层实现

```java
// TradeService.java
public interface TradeService extends BaseService<TradeConditionEntity, TradeEntity> {

    /**
     * 创建订单
     */
    Long createOrder(TradeRequest request);

    /**
     * 订单付款
     */
    void payOrder(Long orderId, Integer payType);

    /**
     * 订单发货
     */
    void shippedOrder(List<Long> orderIds);

    /**
     * 订单收货
     */
    void receiveOrder(Long orderId);

    /**
     * 取消订单
     */
    void cancelOrder(Long orderId);
}
```

```java
// TradeServiceImpl.java
@Service
@Slf4j
public class TradeServiceImpl extends BaseServiceImpl<TradeConditionEntity, TradeEntity> implements TradeService {

    @Autowired
    private TradeMapper tradeMapper;

    @Autowired
    private TradeItemMapper tradeItemMapper;

    @Autowired
    private ProductService productService;

    @Autowired
    private ShoppingCartService shoppingCartService;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public Long createOrder(TradeRequest request) {
        Long userId = UserContext.getCurrentUserId();

        // 1. 生成订单号
        String tradeNo = OrderCodeUtil.generate();

        // 2. 计算订单金额
        BigDecimal totalAmount = BigDecimal.ZERO;
        List<TradeItemEntity> items = new ArrayList<>();

        for (CartItem item : request.getCartItems()) {
            ProductEntity product = productService.findById(item.getProductId());

            // 验证库存
            if (product.getStock() < item.getCount()) {
                throw new BusinessException("商品库存不足: " + product.getName());
            }

            // 计算商品总价
            BigDecimal itemTotal = product.getPrice().multiply(BigDecimal.valueOf(item.getCount()));
            totalAmount = totalAmount.add(itemTotal);

            // 创建订单项
            TradeItemEntity tradeItem = new TradeItemEntity();
            tradeItem.setTradeId(null);
            tradeItem.setProductId(product.getId());
            tradeItem.setProductName(product.getName());
            tradeItem.setProductPhoto(product.getPhoto());
            tradeItem.setProductPrice(product.getPrice());
            tradeItem.setProductCount(item.getCount());
            tradeItem.setProductTotalPrice(itemTotal);
            items.add(tradeItem);

            // 扣减库存
            productService.reduceStock(product.getId(), item.getCount());

            // 删除购物车
            shoppingCartService.deleteById(item.getCartId());
        }

        // 3. 创建订单
        TradeEntity trade = new TradeEntity();
        trade.setTradeNo(tradeNo);
        trade.setUserId(userId);
        trade.setTotalAmount(totalAmount);
        trade.setPayAmount(totalAmount);
        trade.setStatus(OrderStatusEnum.PENDING_PAY.getValue());
        trade.setConsigneeName(request.getConsigneeName());
        trade.setConsigneePhone(request.getConsigneePhone());
        trade.setConsigneeAddress(request.getConsigneeAddress());
        trade.setRemark(request.getRemark());
        FillUserUtil.fillCreateUserInfo(trade);
        tradeMapper.insert(trade);

        // 4. 创建订单项
        for (TradeItemEntity item : items) {
            item.setTradeId(trade.getId());
            tradeItemMapper.insert(item);
        }

        return trade.getId();
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void payOrder(Long orderId, Integer payType) {
        TradeEntity trade = tradeMapper.selectById(orderId);
        if (trade == null) {
            throw new BusinessException("订单不存在");
        }
        if (!OrderStatusEnum.PENDING_PAY.getValue().equals(trade.getStatus())) {
            throw new BusinessException("订单状态异常");
        }

        trade.setStatus(OrderStatusEnum.PAID.getValue());
        trade.setPayType(payType);
        trade.setPayTime(new Date());
        tradeMapper.update(trade);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void shippedOrder(List<Long> orderIds) {
        for (Long orderId : orderIds) {
            TradeEntity trade = tradeMapper.selectById(orderId);
            if (trade == null) {
                throw new BusinessException("订单不存在: " + orderId);
            }
            if (!OrderStatusEnum.PAID.getValue().equals(trade.getStatus())) {
                throw new BusinessException("订单状态异常，无法发货");
            }

            trade.setStatus(OrderStatusEnum.SHIPPED.getValue());
            trade.setConsignTime(new Date());
            tradeMapper.update(trade);
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void receiveOrder(Long orderId) {
        TradeEntity trade = tradeMapper.selectById(orderId);
        if (trade == null) {
            throw new BusinessException("订单不存在");
        }
        if (!OrderStatusEnum.SHIPPED.getValue().equals(trade.getStatus())) {
            throw new BusinessException("订单状态异常，无法收货");
        }

        trade.setStatus(OrderStatusEnum.COMPLETED.getValue());
        trade.setFinishTime(new Date());
        tradeMapper.update(trade);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void cancelOrder(Long orderId) {
        TradeEntity trade = tradeMapper.selectById(orderId);
        if (trade == null) {
            throw new BusinessException("订单不存在");
        }

        // 恢复库存
        List<TradeItemEntity> items = tradeItemMapper.findByTradeId(orderId);
        for (TradeItemEntity item : items) {
            productService.addStock(item.getProductId(), item.getProductCount());
        }

        trade.setStatus(OrderStatusEnum.CANCELLED.getValue());
        tradeMapper.update(trade);
    }
}
```

#### 3.3.4 Controller层实现

```java
// TradeController.java
@RestController
@RequestMapping("/v1/trade")
@Api(tags = "订单管理")
public class TradeController {

    @Autowired
    private TradeService tradeService;

    @PostMapping("/searchByPage")
    @ApiOperation(notes = "分页查询订单", value = "分页查询订单")
    public ApiResult<PageData<TradeEntity>> searchByPage(@RequestBody TradeConditionEntity condition) {
        List<TradeEntity> list = tradeService.searchByCondition(condition);
        int count = tradeService.searchCount(condition);
        return ApiResultUtil.success(PageData.of(count, list));
    }

    @GetMapping("/findById")
    @ApiOperation(notes = "查询订单详情", value = "查询订单详情")
    public ApiResult<TradeEntity> findById(@RequestParam Long id) {
        TradeEntity trade = tradeService.findById(id);
        return ApiResultUtil.success(trade);
    }

    @PostMapping("/insert")
    @ApiOperation(notes = "创建订单", value = "创建订单")
    public ApiResult<Long> createOrder(@RequestBody TradeRequest request) {
        Long orderId = tradeService.createOrder(request);
        return ApiResultUtil.success(orderId);
    }

    @PostMapping("/update")
    @ApiOperation(notes = "修改订单", value = "修改订单")
    public ApiResult<Void> update(@RequestBody TradeEntity trade) {
        tradeService.update(trade);
        return ApiResultUtil.success();
    }

    @PostMapping("/deleteByIds")
    @ApiOperation(notes = "删除订单", value = "删除订单")
    public ApiResult<Void> deleteByIds(@RequestBody List<Long> ids) {
        tradeService.deleteByIds(ids);
        return ApiResultUtil.success();
    }

    @PostMapping("/shippedByIds")
    @ApiOperation(notes = "订单发货", value = "订单发货")
    public ApiResult<Void> shipped(@RequestBody List<Long> ids) {
        tradeService.shippedOrder(ids);
        return ApiResultUtil.success();
    }
}
```

#### 3.3.5 前端API调用

```javascript
// trade.js
import request from '@/utils/request'

export function add(data) {
  return request({
    url: 'v1/trade/insert',
    method: 'post',
    data
  })
}

export function del(ids) {
  return request({
    url: 'v1/trade/deleteByIds',
    method: 'post',
    data: ids
  })
}

export function edit(data) {
  return request({
    url: 'v1/trade/update',
    method: 'post',
    data
  })
}

export function shipped(ids) {
  return request({
    url: 'v1/trade/shippedByIds',
    method: 'post',
    data: ids
  })
}

export default { add, edit, del, shipped }
```

---

## 四、业务功能模块（P1优先级）

### 4.1 购物车模块

#### 4.1.1 数据库表结构

```sql
-- 购物车表
CREATE TABLE `shop_shopping_cart` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '购物车ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `product_id` bigint NOT NULL COMMENT '商品ID',
  `product_count` int NOT NULL DEFAULT 1 COMMENT '商品数量',
  `is_del` tinyint DEFAULT 0,
  `create_user_id` bigint DEFAULT NULL,
  `create_user_name` varchar(50) DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  `update_user_id` bigint DEFAULT NULL,
  `update_user_name` varchar(50) DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='购物车表';

-- 收货地址表
CREATE TABLE `shop_delivery_address` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `name` varchar(50) NOT NULL COMMENT '收货人姓名',
  `phone` varchar(20) NOT NULL COMMENT '收货人电话',
  `province` varchar(50) DEFAULT NULL COMMENT '省份',
  `city` varchar(50) DEFAULT NULL COMMENT '城市',
  `district` varchar(50) DEFAULT NULL COMMENT '区县',
  `detail_address` varchar(200) NOT NULL COMMENT '详细地址',
  `is_default` tinyint DEFAULT 0 COMMENT '是否默认：0-否，1-是',
  `is_del` tinyint DEFAULT 0,
  `create_user_id` bigint DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='收货地址表';

-- 商品收藏表
CREATE TABLE `shop_product_favorites` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `product_id` bigint NOT NULL COMMENT '商品ID',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_product` (`user_id`, `product_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品收藏表';

-- 商品浏览记录表
CREATE TABLE `shop_product_view_record` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint COMMENT '用户ID(未登录可为null)',
  `product_id` bigint NOT NULL COMMENT '商品ID',
  `view_time` datetime DEFAULT NULL COMMENT '浏览时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品浏览记录表';
```

#### 4.1.2 实体类定义

```java
// ShoppingCartEntity.java
@Data
@TableName("shop_shopping_cart")
public class ShoppingCartEntity extends BaseEntity {
    private Long id;
    private Long userId;
    private Long productId;
    private Integer productCount;
    
    // 关联字段
    @TableField(exist = false)
    private String productName;
    @TableField(exist = false)
    private String productPhoto;
    @TableField(exist = false)
    private BigDecimal productPrice;
    @TableField(exist = false)
    private Integer productStock;
}

// DeliveryAddressEntity.java
@Data
@TableName("shop_delivery_address")
public class DeliveryAddressEntity extends BaseEntity {
    private Long id;
    private Long userId;
    private String name;
    private String phone;
    private String province;
    private String city;
    private String district;
    private String detailAddress;
    private Integer isDefault;
}

// ProductFavoritesEntity.java
@Data
@TableName("shop_product_favorites")
public class ProductFavoritesEntity extends BaseEntity {
    private Long id;
    private Long userId;
    private Long productId;
}

// ProductViewRecordEntity.java
@Data
@TableName("shop_product_view_record")
public class ProductViewRecordEntity extends BaseEntity {
    private Long id;
    private Long userId;
    private Long productId;
    private Date viewTime;
}
```

#### 4.1.3 Service层实现

```java
// ShoppingCartService.java
public interface ShoppingCartService extends BaseService<ShoppingCartConditionEntity, ShoppingCartEntity> {

    /**
     * 添加到购物车
     */
    Long addToCart(Long productId, Integer count);

    /**
     * 修改购物车数量
     */
    void updateCount(Long cartId, Integer count);

    /**
     * 清空购物车
     */
    void clearCart();

    /**
     * 获取购物车列表
     */
    List<ShoppingCartEntity> getCartList();
}
```

```java
// ShoppingCartServiceImpl.java
@Service
@Slf4j
public class ShoppingCartServiceImpl extends BaseServiceImpl<ShoppingCartConditionEntity, ShoppingCartEntity> 
        implements ShoppingCartService {

    @Autowired
    private ShoppingCartMapper shoppingCartMapper;

    @Autowired
    private ProductMapper productMapper;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public Long addToCart(Long productId, Integer count) {
        Long userId = UserContext.getCurrentUserId();
        
        // 1. 检查商品是否存在
        ProductEntity product = productMapper.selectById(productId);
        if (product == null) {
            throw new BusinessException("商品不存在");
        }
        
        // 2. 检查库存
        if (product.getStock() < count) {
            throw new BusinessException("库存不足");
        }
        
        // 3. 检查购物车中是否已有该商品
        ShoppingCartConditionEntity condition = new ShoppingCartConditionEntity();
        condition.setUserId(userId);
        condition.setProductId(productId);
        List<ShoppingCartEntity> existList = shoppingCartMapper.searchByCondition(condition);
        
        if (CollectionUtils.isNotEmpty(existList)) {
            // 已有，更新数量
            ShoppingCartEntity existCart = existList.get(0);
            existCart.setProductCount(existCart.getProductCount() + count);
            shoppingCartMapper.update(existCart);
            return existCart.getId();
        }
        
        // 4. 新增购物车
        ShoppingCartEntity cart = new ShoppingCartEntity();
        cart.setUserId(userId);
        cart.setProductId(productId);
        cart.setProductCount(count);
        FillUserUtil.fillCreateUserInfo(cart);
        shoppingCartMapper.insert(cart);
        
        return cart.getId();
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void updateCount(Long cartId, Integer count) {
        ShoppingCartEntity cart = shoppingCartMapper.selectById(cartId);
        if (cart == null) {
            throw new BusinessException("购物车记录不存在");
        }
        
        if (!cart.getUserId().equals(UserContext.getCurrentUserId())) {
            throw new BusinessException("无权操作");
        }
        
        cart.setProductCount(count);
        shoppingCartMapper.update(cart);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void clearCart() {
        Long userId = UserContext.getCurrentUserId();
        shoppingCartMapper.deleteByUserId(userId);
    }

    @Override
    public List<ShoppingCartEntity> getCartList() {
        Long userId = UserContext.getCurrentUserId();
        ShoppingCartConditionEntity condition = new ShoppingCartConditionEntity();
        condition.setUserId(userId);
        return shoppingCartMapper.searchByCondition(condition);
    }
}
```

#### 4.1.4 Controller层实现

```java
// ShoppingCartController.java
@RestController
@RequestMapping("/v1/shoppingCart")
@Api(tags = "购物车管理")
public class ShoppingCartController {

    @Autowired
    private ShoppingCartService shoppingCartService;

    @PostMapping("/searchByPage")
    @ApiOperation(notes = "分页查询购物车", value = "分页查询购物车")
    public ApiResult<PageData<ShoppingCartEntity>> searchByPage(@RequestBody ShoppingCartConditionEntity condition) {
        List<ShoppingCartEntity> list = shoppingCartService.searchByCondition(condition);
        int count = shoppingCartService.searchCount(condition);
        return ApiResultUtil.success(PageData.of(count, list));
    }

    @PostMapping("/insert")
    @ApiOperation(notes = "添加到购物车", value = "添加到购物车")
    public ApiResult<Long> addToCart(@RequestBody AddCartRequest request) {
        Long cartId = shoppingCartService.addToCart(request.getProductId(), request.getCount());
        return ApiResultUtil.success(cartId);
    }

    @PostMapping("/update")
    @ApiOperation(notes = "修改购物车数量", value = "修改购物车数量")
    public ApiResult<Void> update(@RequestBody UpdateCartRequest request) {
        shoppingCartService.updateCount(request.getCartId(), request.getCount());
        return ApiResultUtil.success();
    }

    @PostMapping("/deleteByIds")
    @ApiOperation(notes = "删除购物车", value = "删除购物车")
    public ApiResult<Void> deleteByIds(@RequestBody List<Long> ids) {
        shoppingCartService.deleteByIds(ids);
        return ApiResultUtil.success();
    }

    @PostMapping("/clear")
    @ApiOperation(notes = "清空购物车", value = "清空购物车")
    public ApiResult<Void> clear() {
        shoppingCartService.clearCart();
        return ApiResultUtil.success();
    }
}
```

#### 4.1.5 前端API调用

```javascript
// shoppingCart.js
import request from '@/utils/request'

export function getPage(params) {
  const data = params
  return request({
    url: '/v1/shoppingCart/searchByPage',
    method: 'post',
    data
  })
}

export function add(data) {
  return request({
    url: 'v1/shoppingCart/insert',
    method: 'post',
    data
  })
}

export function del(ids) {
  return request({
    url: 'v1/shoppingCart/deleteByIds',
    method: 'post',
    data: ids
  })
}

export function edit(data) {
  return request({
    url: 'v1/shoppingCart/update',
    method: 'post',
    data
  })
}

export default { add, edit, del, getPage }
```

---

### 4.2 优惠券模块

#### 4.2.1 数据库表结构

```sql
-- 优惠券表
CREATE TABLE `mkt_coupon` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(100) NOT NULL COMMENT '优惠券名称',
  `type` tinyint NOT NULL COMMENT '优惠券类型：1-满减券，2-折扣券',
  `min_amount` decimal(10,2) DEFAULT 0.00 COMMENT '使用门槛金额',
  `discount_amount` decimal(10,2) DEFAULT NULL COMMENT '优惠金额(满减)',
  `discount_rate` decimal(3,2) DEFAULT NULL COMMENT '折扣率(折扣)',
  `total_count` int DEFAULT NULL COMMENT '总发行量',
  `user_limit_count` int DEFAULT 1 COMMENT '每人限领数量',
  `valid_type` tinyint DEFAULT 1 COMMENT '有效期类型：1-固定时间，2-领取后N天',
  `valid_start_time` datetime DEFAULT NULL COMMENT '固定有效期开始时间',
  `valid_end_time` datetime DEFAULT NULL COMMENT '固定有效期结束时间',
  `valid_days` int DEFAULT NULL COMMENT '领取后有效天数',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-未开始，1-进行中，2-已结束',
  `receive_count` int DEFAULT 0 COMMENT '已领取数量',
  `use_count` int DEFAULT 0 COMMENT '已使用数量',
  `is_del` tinyint DEFAULT 0,
  `create_user_id` bigint DEFAULT NULL,
  `create_user_name` varchar(50) DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券表';

-- 用户优惠券表
CREATE TABLE `mkt_coupon_user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `coupon_id` bigint NOT NULL COMMENT '优惠券ID',
  `status` tinyint DEFAULT 1 COMMENT '状态：1-未使用，2-已使用，3-已过期',
  `receive_time` datetime DEFAULT NULL COMMENT '领取时间',
  `use_time` datetime DEFAULT NULL COMMENT '使用时间',
  `order_id` bigint DEFAULT NULL COMMENT '使用订单ID',
  `valid_start_time` datetime DEFAULT NULL COMMENT '有效期开始时间',
  `valid_end_time` datetime DEFAULT NULL COMMENT '有效期结束时间',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_user_status` (`user_id`, `status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户优惠券表';

-- 优惠券发放记录表
CREATE TABLE `mkt_coupon_user_provide` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `coupon_id` bigint NOT NULL COMMENT '优惠券ID',
  `provide_type` tinyint NOT NULL COMMENT '发放类型：1-手动发放，2-新人专享，3-活动发放',
  `user_ids` text COMMENT '发放用户ID列表(JSON)',
  `total_count` int DEFAULT NULL COMMENT '发放数量',
  `status` tinyint DEFAULT 1 COMMENT '状态：1-待执行，2-执行中，3-已完成',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券发放记录表';
```

#### 4.2.2 实体类定义

```java
// CouponEntity.java
@Data
@TableName("mkt_coupon")
public class CouponEntity extends BaseEntity {
    private Long id;
    private String name;
    private Integer type;
    private BigDecimal minAmount;
    private BigDecimal discountAmount;
    private BigDecimal discountRate;
    private Integer totalCount;
    private Integer userLimitCount;
    private Integer validType;
    private Date validStartTime;
    private Date validEndTime;
    private Integer validDays;
    private Integer status;
    private Integer receiveCount;
    private Integer useCount;
}

// CouponUserEntity.java
@Data
@TableName("mkt_coupon_user")
public class CouponUserEntity extends BaseEntity {
    private Long id;
    private Long userId;
    private Long couponId;
    private Integer status;
    private Date receiveTime;
    private Date useTime;
    private Long orderId;
    private Date validStartTime;
    private Date validEndTime;
    
    // 关联字段
    @TableField(exist = false)
    private String couponName;
    @TableField(exist = false)
    private BigDecimal couponAmount;
}
```

#### 4.2.3 Service层实现

```java
// CouponService.java
public interface CouponService extends BaseService<CouponConditionEntity, CouponEntity> {

    /**
     * 领取优惠券
     */
    Long receiveCoupon(Long couponId);

    /**
     * 使用优惠券
     */
    void useCoupon(Long couponUserId, Long orderId);

    /**
     * 退还优惠券
     */
    void returnCoupon(Long couponUserId);

    /**
     * 获取用户优惠券列表
     */
    List<CouponUserEntity> getUserCoupons(Long userId, Integer status);

    /**
     * 发放优惠券
     */
    void provideCoupon(ProvideCouponRequest request);
}
```

```java
// CouponServiceImpl.java
@Service
@Slf4j
public class CouponServiceImpl extends BaseServiceImpl<CouponConditionEntity, CouponEntity> implements CouponService {

    @Autowired
    private CouponMapper couponMapper;

    @Autowired
    private CouponUserMapper couponUserMapper;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public Long receiveCoupon(Long couponId) {
        Long userId = UserContext.getCurrentUserId();
        
        // 1. 检查优惠券是否存在
        CouponEntity coupon = couponMapper.selectById(couponId);
        if (coupon == null) {
            throw new BusinessException("优惠券不存在");
        }
        
        // 2. 检查优惠券状态
        if (!CouponStatusEnum.ACTIVE.getValue().equals(coupon.getStatus())) {
            throw new BusinessException("优惠券未开始或已结束");
        }
        
        // 3. 检查库存
        if (coupon.getTotalCount() != null && coupon.getReceiveCount() >= coupon.getTotalCount()) {
            throw new BusinessException("优惠券已领完");
        }
        
        // 4. 检查用户限领数量
        int userReceivedCount = couponUserMapper.countByUserAndCoupon(userId, couponId);
        if (userReceivedCount >= coupon.getUserLimitCount()) {
            throw new BusinessException("超出限领数量");
        }
        
        // 5. 计算有效期
        Date validStartTime;
        Date validEndTime;
        if (CouponValidTypeEnum.FIXED.getValue().equals(coupon.getValidType())) {
            validStartTime = coupon.getValidStartTime();
            validEndTime = coupon.getValidEndTime();
        } else {
            validStartTime = new Date();
            validEndTime = DateUtils.addDays(validStartTime, coupon.getValidDays());
        }
        
        // 6. 领取优惠券
        CouponUserEntity couponUser = new CouponUserEntity();
        couponUser.setUserId(userId);
        couponUser.setCouponId(couponId);
        couponUser.setStatus(CouponUserStatusEnum.UNUSED.getValue());
        couponUser.setReceiveTime(new Date());
        couponUser.setValidStartTime(validStartTime);
        couponUser.setValidEndTime(validEndTime);
        FillUserUtil.fillCreateUserInfo(couponUser);
        couponUserMapper.insert(couponUser);
        
        // 7. 更新领取数量
        coupon.setReceiveCount(coupon.getReceiveCount() + 1);
        couponMapper.update(coupon);
        
        return couponUser.getId();
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void useCoupon(Long couponUserId, Long orderId) {
        CouponUserEntity couponUser = couponUserMapper.selectById(couponUserId);
        if (couponUser == null) {
            throw new BusinessException("用户优惠券不存在");
        }
        
        if (!CouponUserStatusEnum.UNUSED.getValue().equals(couponUser.getStatus())) {
            throw new BusinessException("优惠券状态异常");
        }
        
        // 检查是否过期
        if (new Date().after(couponUser.getValidEndTime())) {
            couponUser.setStatus(CouponUserStatusEnum.EXPIRED.getValue());
            couponUserMapper.update(couponUser);
            throw new BusinessException("优惠券已过期");
        }
        
        // 使用优惠券
        couponUser.setStatus(CouponUserStatusEnum.USED.getValue());
        couponUser.setUseTime(new Date());
        couponUser.setOrderId(orderId);
        couponUserMapper.update(couponUser);
    }
}
```

#### 4.2.4 Controller层实现

```java
// CouponController.java
@RestController
@RequestMapping("/v1/coupon")
@Api(tags = "优惠券管理")
public class CouponController {

    @Autowired
    private CouponService couponService;

    @PostMapping("/searchByPage")
    @ApiOperation(notes = "分页查询优惠券", value = "分页查询优惠券")
    public ApiResult<PageData<CouponEntity>> searchByPage(@RequestBody CouponConditionEntity condition) {
        List<CouponEntity> list = couponService.searchByCondition(condition);
        int count = couponService.searchCount(condition);
        return ApiResultUtil.success(PageData.of(count, list));
    }

    @GetMapping("/findById")
    @ApiOperation(notes = "查询优惠券详情", value = "查询优惠券详情")
    public ApiResult<CouponEntity> findById(@RequestParam Long id) {
        CouponEntity coupon = couponService.findById(id);
        return ApiResultUtil.success(coupon);
    }

    @PostMapping("/insert")
    @ApiOperation(notes = "新增优惠券", value = "新增优惠券")
    public ApiResult<Void> insert(@RequestBody CouponEntity coupon) {
        couponService.insert(coupon);
        return ApiResultUtil.success();
    }

    @PostMapping("/update")
    @ApiOperation(notes = "修改优惠券", value = "修改优惠券")
    public ApiResult<Void> update(@RequestBody CouponEntity coupon) {
        couponService.update(coupon);
        return ApiResultUtil.success();
    }

    @PostMapping("/deleteByIds")
    @ApiOperation(notes = "删除优惠券", value = "删除优惠券")
    public ApiResult<Void> deleteByIds(@RequestBody List<Long> ids) {
        couponService.deleteByIds(ids);
        return ApiResultUtil.success();
    }

    @PostMapping("/receive")
    @ApiOperation(notes = "领取优惠券", value = "领取优惠券")
    public ApiResult<Long> receiveCoupon(@RequestParam Long couponId) {
        Long couponUserId = couponService.receiveCoupon(couponId);
        return ApiResultUtil.success(couponUserId);
    }
}
```

#### 4.2.5 前端API调用

```javascript
// coupon.js
import request from '@/utils/request'

export function getPage(params) {
  const data = params
  return request({
    url: '/v1/coupon/searchByPage',
    method: 'post',
    data
  })
}

export function add(data) {
  return request({
    url: 'v1/coupon/insert',
    method: 'post',
    data
  })
}

export function del(ids) {
  return request({
    url: 'v1/coupon/deleteByIds',
    method: 'post',
    data: ids
  })
}

export function edit(data) {
  return request({
    url: 'v1/coupon/update',
    method: 'post',
    data
  })
}

export default { add, edit, del, getPage }
```

---

### 4.3 支付模块

#### 4.3.1 数据库表结构

```sql
-- 支付记录表
CREATE TABLE `pay_payment` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `trade_no` varchar(50) NOT NULL COMMENT '订单号',
  `pay_no` varchar(50) NOT NULL COMMENT '支付流水号',
  `pay_type` tinyint NOT NULL COMMENT '支付方式：1-支付宝，2-微信',
  `amount` decimal(10,2) NOT NULL COMMENT '支付金额',
  `status` tinyint DEFAULT 0 COMMENT '支付状态：0-待支付，1-支付成功，2-支付失败',
  `pay_time` datetime DEFAULT NULL COMMENT '支付时间',
  `notify_time` datetime DEFAULT NULL COMMENT '支付通知时间',
  `notify_data` text COMMENT '支付通知数据',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_pay_no` (`pay_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='支付记录表';
```

#### 4.3.2 支付宝集成配置

```java
// AliPayConfig.java
@Configuration
@ConfigurationProperties(prefix = "alipay")
@Data
public class AliPayConfig {

    private String appId;
    private String privateKey;
    private String publicKey;
    private String notifyUrl;
    private String returnUrl;
    
    @Bean
    public AlipayClient alipayClient() {
        return new AlipayClient(
            "https://openapi.alipay.com/gateway.do",
            appId,
            privateKey,
            "json",
            "UTF-8",
            publicKey,
            "RSA2"
        );
    }
}
```

```yaml
# application.yml
alipay:
  appId: 2021000000000000
  privateKey: MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSj...
  publicKey: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
  notifyUrl: http://your-domain.com/v1/web/pay/aliPay/notify
  returnUrl: http://your-domain.com/pay/result
```

#### 4.3.3 Service层实现

```java
// PayService.java
public interface PayService {

    /**
     * 发起支付宝支付
     */
    String createAliPayOrder(Long orderId);

    /**
     * 支付宝异步回调
     */
    void aliPayNotify(AliPayNotifyRequest request);

    /**
     * 查询支付状态
     */
    PayStatusEnum queryPayStatus(String payNo);

    /**
     * 申请退款
     */
    void refund(Long orderId, BigDecimal refundAmount);
}
```

```java
// PayServiceImpl.java
@Service
@Slf4j
public class PayServiceImpl implements PayService {

    @Autowired
    private AlipayClient alipayClient;

    @Autowired
    private TradeService tradeService;

    @Autowired
    private PaymentMapper paymentMapper;

    @Autowired
    private AliPayConfig aliPayConfig;

    @Override
    public String createAliPayOrder(Long orderId) {
        TradeEntity trade = tradeService.findById(orderId);
        if (trade == null) {
            throw new BusinessException("订单不存在");
        }
        
        // 生成支付流水号
        String payNo = OrderCodeUtil.generatePayNo();
        
        // 创建支付记录
        PaymentEntity payment = new PaymentEntity();
        payment.setTradeNo(trade.getTradeNo());
        payment.setPayNo(payNo);
        payment.setPayType(PayTypeEnum.ALIPAY.getValue());
        payment.setAmount(trade.getPayAmount());
        payment.setStatus(PayStatusEnum.PENDING.getValue());
        FillUserUtil.fillCreateUserInfo(payment);
        paymentMapper.insert(payment);
        
        // 调用支付宝API
        AlipayTradeAppPayRequest request = new AlipayTradeAppPayRequest();
        request.setNotifyUrl(aliPayConfig.getNotifyUrl());
        request.setReturnUrl(aliPayConfig.getReturnUrl());
        
        AlipayTradeAppPayModel model = new AlipayTradeAppPayModel();
        model.setOutTradeNo(payNo);
        model.setTotalAmount(trade.getPayAmount().toString());
        model.setSubject(trade.getTradeNo());
        model.setBody("订单支付");
        model.setProductCode("QUICK_WAP_WAY");
        
        request.setBizModel(model);
        
        try {
            AlipayTradeAppPayResponse response = alipayClient.sdkExecute(request);
            return response.getBody();
        } catch (AlipayApiException e) {
            log.error("支付宝支付创建失败", e);
            throw new BusinessException("支付创建失败");
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void aliPayNotify(AliPayNotifyRequest request) {
        log.info("支付宝异步通知：{}", request);
        
        // 1. 验签
        boolean signVerified = AlipaySignature.rsaCheckV1(
            request.getParams(),
            aliPayConfig.getPublicKey(),
            "UTF-8",
            "RSA2"
        );
        
        if (!signVerified) {
            throw new BusinessException("验签失败");
        }
        
        // 2. 检查支付状态
        if (!"TRADE_SUCCESS".equals(request.getTradeStatus()) && !"TRADE_FINISHED".equals(request.getTradeStatus())) {
            return;
        }
        
        // 3. 更新支付记录
        String payNo = request.getOutTradeNo();
        PaymentEntity payment = paymentMapper.findByPayNo(payNo);
        if (payment == null) {
            throw new BusinessException("支付记录不存在");
        }
        
        if (!PayStatusEnum.PENDING.getValue().equals(payment.getStatus())) {
            return;
        }
        
        payment.setStatus(PayStatusEnum.SUCCESS.getValue());
        payment.setPayTime(new Date());
        payment.setNotifyTime(new Date());
        payment.setNotifyData(JSONUtil.toJsonStr(request.getParams()));
        paymentMapper.update(payment);
        
        // 4. 更新订单状态
        TradeEntity trade = tradeService.findByTradeNo(payment.getTradeNo());
        trade.setStatus(OrderStatusEnum.PAID.getValue());
        trade.setPayType(PayTypeEnum.ALIPAY.getValue());
        trade.setPayTime(new Date());
        tradeService.update(trade);
    }

    @Override
    public PayStatusEnum queryPayStatus(String payNo) {
        PaymentEntity payment = paymentMapper.findByPayNo(payNo);
        return PayStatusEnum.of(payment.getStatus());
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void refund(Long orderId, BigDecimal refundAmount) {
        TradeEntity trade = tradeService.findById(orderId);
        if (trade == null) {
            throw new BusinessException("订单不存在");
        }
        
        // 调用支付宝退款API
        AlipayTradeRefundRequest request = new AlipayTradeRefundRequest();
        AlipayTradeRefundModel model = new AlipayTradeRefundModel();
        model.setOutTradeNo(trade.getTradeNo());
        model.setRefundAmount(refundAmount.toString());
        model.setOutRequestNo(OrderCodeUtil.generatePayNo());
        request.setBizModel(model);
        
        try {
            alipayClient.execute(request);
            // 更新订单状态
            trade.setStatus(OrderStatusEnum.REFUNDED.getValue());
            tradeService.update(trade);
        } catch (AlipayApiException e) {
            log.error("支付宝退款失败", e);
            throw new BusinessException("退款失败");
        }
    }
}
```

#### 4.3.4 Controller层实现

```java
// WebPayController.java
@RestController
@RequestMapping("/v1/web/pay")
@Api(tags = "支付管理")
public class WebPayController {

    @Autowired
    private PayService payService;

    @PostMapping("/aliPay")
    @ApiOperation(notes = "发起支付宝支付", value = "发起支付宝支付")
    public ApiResult<String> createAliPayOrder(@RequestParam Long orderId) {
        String payParams = payService.createAliPayOrder(orderId);
        return ApiResultUtil.success(payParams);
    }

    @PostMapping("/aliPay/notify")
    @NoLogin
    @ApiOperation(notes = "支付宝异步通知", value = "支付宝异步通知")
    public String aliPayNotify(HttpServletRequest request) {
        Map<String, String> params = new HashMap<>();
        Enumeration<String> parameterNames = request.getParameterNames();
        while (parameterNames.hasMoreElements()) {
            String name = parameterNames.nextElement();
            params.put(name, request.getParameter(name));
        }
        
        AliPayNotifyRequest notifyRequest = new AliPayNotifyRequest();
        notifyRequest.setParams(params);
        notifyRequest.setTradeStatus(request.getParameter("trade_status"));
        notifyRequest.setOutTradeNo(request.getParameter("out_trade_no"));
        
        try {
            payService.aliPayNotify(notifyRequest);
            return "success";
        } catch (Exception e) {
            log.error("支付宝回调处理失败", e);
            return "fail";
        }
    }

    @GetMapping("/query/{payNo}")
    @ApiOperation(notes = "查询支付状态", value = "查询支付状态")
    public ApiResult<PayStatusEnum> queryPayStatus(@PathVariable String payNo) {
        PayStatusEnum status = payService.queryPayStatus(payNo);
        return ApiResultUtil.success(status);
    }

    @PostMapping("/refund")
    @ApiOperation(notes = "申请退款", value = "申请退款")
    public ApiResult<Void> refund(@RequestBody RefundRequest request) {
        payService.refund(request.getOrderId(), request.getRefundAmount());
        return ApiResultUtil.success();
    }
}
```

#### 4.3.5 前端API调用

```javascript
// aliPay.js
import request from '@/utils/request'

export function get() {
  return request({
    url: 'api/aliPay',
    method: 'get'
  })
}

export function update(data) {
  return request({
    url: 'api/aliPay',
    data,
    method: 'put'
  })
}

// 支付
export function toAliPay(url, data) {
  return request({
    url: 'api/' + url,
    data,
    method: 'post'
  })
}
```

---

## 五、业务扩展模块（P2优先级）

### 5.1 售后模块

#### 5.1.1 数据库表结构

```sql
-- 退款申请表
CREATE TABLE `aft_refund` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `trade_id` bigint NOT NULL COMMENT '订单ID',
  `trade_item_id` bigint NOT NULL COMMENT '订单项ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `refund_no` varchar(50) NOT NULL COMMENT '退款单号',
  `refund_amount` decimal(10,2) NOT NULL COMMENT '退款金额',
  `refund_type` tinyint DEFAULT 1 COMMENT '退款类型：1-仅退款，2-退货退款',
  `refund_reason` varchar(200) NOT NULL COMMENT '退款原因',
  `refund_status` tinyint DEFAULT 0 COMMENT '退款状态：0-待审核，1-审核通过，2-审核拒绝，3-退款成功',
  `refuse_reason` varchar(200) DEFAULT NULL COMMENT '拒绝原因',
  `apply_time` datetime DEFAULT NULL COMMENT '申请时间',
  `audit_time` datetime DEFAULT NULL COMMENT '审核时间',
  `refund_time` datetime DEFAULT NULL COMMENT '退款时间',
  `is_del` tinyint DEFAULT 0,
  `create_user_id` bigint DEFAULT NULL,
  `create_user_name` varchar(50) DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_trade_item` (`trade_item_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='退款申请表';
```

#### 5.1.2 实体类定义

```java
// RefundEntity.java
@Data
@TableName("aft_refund")
public class RefundEntity extends BaseEntity {
    private Long id;
    private Long tradeId;
    private Long tradeItemId;
    private Long userId;
    private String refundNo;
    private BigDecimal refundAmount;
    private Integer refundType;
    private String refundReason;
    private Integer refundStatus;
    private String refuseReason;
    private Date applyTime;
    private Date auditTime;
    private Date refundTime;
    
    // 关联字段
    @TableField(exist = false)
    private String tradeNo;
    @TableField(exist = false)
    private String productName;
    @TableField(exist = false)
    private String userNickName;
}
```

#### 5.1.3 Service层实现

```java
// RefundService.java
public interface RefundService extends BaseService<RefundConditionEntity, RefundEntity> {

    /**
     * 申请退款
     */
    Long applyRefund(RefundRequest request);

    /**
     * 审核退款
     */
    void auditRefund(Long refundId, Integer status, String refuseReason);
}
```

```java
// RefundServiceImpl.java
@Service
@Slf4j
public class RefundServiceImpl extends BaseServiceImpl<RefundConditionEntity, RefundEntity> implements RefundService {

    @Autowired
    private RefundMapper refundMapper;

    @Autowired
    private TradeService tradeService;

    @Autowired
    private PayService payService;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public Long applyRefund(RefundRequest request) {
        Long userId = UserContext.getCurrentUserId();
        
        // 1. 验证订单
        TradeEntity trade = tradeService.findById(request.getTradeId());
        if (trade == null) {
            throw new BusinessException("订单不存在");
        }
        
        if (!trade.getUserId().equals(userId)) {
            throw new BusinessException("无权操作此订单");
        }
        
        if (!OrderStatusEnum.SHIPPED.getValue().equals(trade.getStatus()) 
            && !OrderStatusEnum.COMPLETED.getValue().equals(trade.getStatus())) {
            throw new BusinessException("当前订单状态不可申请退款");
        }
        
        // 2. 检查是否已有退款申请
        RefundConditionEntity condition = new RefundConditionEntity();
        condition.setTradeItemId(request.getTradeItemId());
        if (CollectionUtils.isNotEmpty(refundMapper.searchByCondition(condition))) {
            throw new BusinessException("该商品已申请退款");
        }
        
        // 3. 创建退款申请
        RefundEntity refund = new RefundEntity();
        refund.setTradeId(request.getTradeId());
        refund.setTradeItemId(request.getTradeItemId());
        refund.setUserId(userId);
        refund.setRefundNo(OrderCodeUtil.generateRefundNo());
        refund.setRefundAmount(request.getRefundAmount());
        refund.setRefundType(request.getRefundType());
        refund.setRefundReason(request.getRefundReason());
        refund.setRefundStatus(RefundStatusEnum.PENDING.getValue());
        refund.setApplyTime(new Date());
        FillUserUtil.fillCreateUserInfo(refund);
        refundMapper.insert(refund);
        
        return refund.getId();
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void auditRefund(Long refundId, Integer status, String refuseReason) {
        RefundEntity refund = refundMapper.selectById(refundId);
        if (refund == null) {
            throw new BusinessException("退款申请不存在");
        }
        
        refund.setRefundStatus(status);
        refund.setAuditTime(new Date());
        refund.setRefuseReason(refuseReason);
        refundMapper.update(refund);
        
        // 审核通过，执行退款
        if (RefundStatusEnum.APPROVED.getValue().equals(status)) {
            payService.refund(refund.getTradeId(), refund.getRefundAmount());
            
            refund.setRefundStatus(RefundStatusEnum.SUCCESS.getValue());
            refund.setRefundTime(new Date());
            refundMapper.update(refund);
        }
    }
}
```

#### 5.1.4 Controller层实现

```java
// RefundController.java
@RestController
@RequestMapping("/v1/refund")
@Api(tags = "退款管理")
public class RefundController {

    @Autowired
    private RefundService refundService;

    @PostMapping("/searchByPage")
    @ApiOperation(notes = "分页查询退款", value = "分页查询退款")
    public ApiResult<PageData<RefundEntity>> searchByPage(@RequestBody RefundConditionEntity condition) {
        List<RefundEntity> list = refundService.searchByCondition(condition);
        int count = refundService.searchCount(condition);
        return ApiResultUtil.success(PageData.of(count, list));
    }

    @GetMapping("/findById")
    @ApiOperation(notes = "查询退款详情", value = "查询退款详情")
    public ApiResult<RefundEntity> findById(@RequestParam Long id) {
        RefundEntity refund = refundService.findById(id);
        return ApiResultUtil.success(refund);
    }

    @PostMapping("/insert")
    @ApiOperation(notes = "申请退款", value = "申请退款")
    public ApiResult<Long> insert(@RequestBody RefundRequest request) {
        Long refundId = refundService.applyRefund(request);
        return ApiResultUtil.success(refundId);
    }

    @PostMapping("/audit")
    @ApiOperation(notes = "审核退款", value = "审核退款")
    public ApiResult<Void> audit(@RequestBody AuditRefundRequest request) {
        refundService.auditRefund(request.getRefundId(), request.getStatus(), request.getRefuseReason());
        return ApiResultUtil.success();
    }

    @PostMapping("/deleteByIds")
    @ApiOperation(notes = "删除退款", value = "删除退款")
    public ApiResult<Void> deleteByIds(@RequestBody List<Long> ids) {
        refundService.deleteByIds(ids);
        return ApiResultUtil.success();
    }
}
```

#### 5.1.5 前端API调用

```javascript
// refund.js
import request from '@/utils/request'

export function getPage(params) {
  const data = params
  return request({
    url: '/v1/refund/searchByPage',
    method: 'post',
    data
  })
}

export function add(data) {
  return request({
    url: 'v1/refund/insert',
    method: 'post',
    data
  })
}

export function del(ids) {
  return request({
    url: 'v1/refund/deleteByIds',
    method: 'post',
    data: ids
  })
}

export function edit(data) {
  return request({
    url: 'v1/refund/update',
    method: 'post',
    data
  })
}

export default { add, edit, del, getPage }
```

---

### 5.2 定时任务模块

#### 5.2.1 数据库表结构

```sql
-- 定时任务表
CREATE TABLE `sys_job` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '任务名称',
  `job_type` tinyint DEFAULT 1 COMMENT '任务类型：1-Java类，2-Spring Bean',
  `invoke_target` varchar(200) NOT NULL COMMENT '调用目标',
  `cron_expression` varchar(50) DEFAULT NULL COMMENT 'Cron表达式',
  `misfire_policy` tinyint DEFAULT 3 COMMENT '错失执行策略：1-立即执行，2-执行一次，3-不执行',
  `status` tinyint DEFAULT 0 COMMENT '状态：0-暂停，1-正常',
  `is_del` tinyint DEFAULT 0,
  `create_user_id` bigint DEFAULT NULL,
  `create_user_name` varchar(50) DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='定时任务表';

-- 定时任务日志表
CREATE TABLE `sys_job_log` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `job_id` bigint NOT NULL COMMENT '任务ID',
  `job_name` varchar(50) NOT NULL COMMENT '任务名称',
  `invoke_target` varchar(200) NOT NULL COMMENT '调用目标',
  `invoke_params` varchar(500) DEFAULT NULL COMMENT '调用参数',
  `status` tinyint DEFAULT 0 COMMENT '执行状态：0-成功，1-失败',
  `error_msg` text COMMENT '错误信息',
  `start_time` datetime DEFAULT NULL COMMENT '开始时间',
  `end_time` datetime DEFAULT NULL COMMENT '结束时间',
  `time_consuming` int DEFAULT 0 COMMENT '执行耗时(毫秒)',
  PRIMARY KEY (`id`),
  KEY `idx_job_id` (`job_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='定时任务日志表';
```

#### 5.2.2 定时任务实现

```java
// QuartzManage.java
@Component
@Slf4j
public class QuartzManage {

    @Autowired
    private Scheduler scheduler;

    /**
     * 添加定时任务
     */
    public void addJob(JobEntity job) {
        try {
            JobDetail jobDetail = JobBuilder.newJob(QuartzExecutionJob.class)
                .withIdentity("job_" + job.getId(), "group_" + job.getId())
                .build();
            
            jobDetail.getJobDataMap().put("jobId", job.getId());
            jobDetail.getJobDataMap().put("invokeTarget", job.getInvokeTarget());
            
            CronTrigger trigger = TriggerBuilder.newTrigger()
                .withIdentity("trigger_" + job.getId(), "group_" + job.getId())
                .withSchedule(CronScheduleBuilder.cronSchedule(job.getCronExpression()))
                .build();
            
            scheduler.scheduleJob(jobDetail, trigger);
            
            log.info("定时任务[{}]添加成功", job.getName());
        } catch (Exception e) {
            log.error("定时任务添加失败", e);
            throw new BusinessException("定时任务添加失败");
        }
    }

    /**
     * 暂停定时任务
     */
    public void pauseJob(Long jobId) {
        try {
            JobKey jobKey = JobKey.jobKey("job_" + jobId, "group_" + jobId);
            scheduler.pauseJob(jobKey);
        } catch (Exception e) {
            log.error("定时任务暂停失败", e);
        }
    }

    /**
     * 恢复定时任务
     */
    public void resumeJob(Long jobId) {
        try {
            JobKey jobKey = JobKey.jobKey("job_" + jobId, "group_" + jobId);
            scheduler.resumeJob(jobKey);
        } catch (Exception e) {
            log.error("定时任务恢复失败", e);
        }
    }

    /**
     * 立即执行一次
     */
    public void runOnce(Long jobId) {
        try {
            JobKey jobKey = JobKey.jobKey("job_" + jobId, "group_" + jobId);
            scheduler.triggerJob(jobKey);
        } catch (Exception e) {
            log.error("定时任务立即执行失败", e);
        }
    }

    /**
     * 删除定时任务
     */
    public void deleteJob(Long jobId) {
        try {
            JobKey jobKey = JobKey.jobKey("job_" + jobId, "group_" + jobId);
            scheduler.deleteJob(jobKey);
        } catch (Exception e) {
            log.error("定时任务删除失败", e);
        }
    }
}
```

```java
// QuartzExecutionJob.java
@Component
public class QuartzExecutionJob implements Job {

    @Autowired
    private JobService jobService;

    @Autowired
    private QuartzManage quartzManage;

    @Autowired
    private JobLogService jobLogService;

    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
        Long jobId = context.getJobDetail().getJobDataMap().getLong("jobId");
        String invokeTarget = context.getJobDetail().getJobDataMap().getString("invokeTarget");
        
        long startTime = System.currentTimeMillis();
        
        JobLogEntity jobLog = new JobLogEntity();
        jobLog.setJobId(jobId);
        jobLog.setInvokeTarget(invokeTarget);
        jobLog.setStartTime(new Date());
        jobLog.setStatus(JobResultEnum.SUCCESS.getValue());
        
        try {
            executeInternal(invokeTarget);
        } catch (Exception e) {
            jobLog.setStatus(JobResultEnum.FAIL.getValue());
            jobLog.setErrorMsg(ExceptionUtils.getMessage(e));
        } finally {
            long endTime = System.currentTimeMillis();
            jobLog.setEndTime(new Date());
            jobLog.setTimeConsuming((int) (endTime - startTime));
            jobLogService.insert(jobLog);
        }
    }
    
    private void executeInternal(String invokeTarget) throws Exception {
        if (invokeTarget.contains(".")) {
            String[] parts = invokeTarget.split("\\.");
            String className = parts[0];
            String methodName = parts[1];
            
            Object target = SpringBeanUtil.getBean(className);
            Method method = target.getClass().getMethod(methodName);
            method.invoke(target);
        }
    }
}
```

#### 5.2.3 Controller层实现

```java
// JobController.java
@RestController
@RequestMapping("/v1/job")
@Api(tags = "定时任务管理")
public class JobController {

    @Autowired
    private JobService jobService;

    @Autowired
    private QuartzManage quartzManage;

    @PostMapping("/searchByPage")
    @ApiOperation(notes = "分页查询定时任务", value = "分页查询定时任务")
    public ApiResult<PageData<JobEntity>> searchByPage(@RequestBody JobConditionEntity condition) {
        List<JobEntity> list = jobService.searchByCondition(condition);
        int count = jobService.searchCount(condition);
        return ApiResultUtil.success(PageData.of(count, list));
    }

    @PostMapping("/insert")
    @ApiOperation(notes = "新增定时任务", value = "新增定时任务")
    public ApiResult<Void> insert(@RequestBody JobEntity job) {
        jobService.insert(job);
        quartzManage.addJob(job);
        return ApiResultUtil.success();
    }

    @PostMapping("/update")
    @ApiOperation(notes = "修改定时任务", value = "修改定时任务")
    public ApiResult<Void> update(@RequestBody JobEntity job) {
        jobService.update(job);
        quartzManage.deleteJob(job.getId());
        quartzManage.addJob(job);
        return ApiResultUtil.success();
    }

    @PostMapping("/deleteByIds")
    @ApiOperation(notes = "删除定时任务", value = "删除定时任务")
    public ApiResult<Void> deleteByIds(@RequestBody List<Long> ids) {
        for (Long id : ids) {
            jobService.deleteById(id);
            quartzManage.deleteJob(id);
        }
        return ApiResultUtil.success();
    }

    @PostMapping("/pause/{id}")
    @ApiOperation(notes = "暂停定时任务", value = "暂停定时任务")
    public ApiResult<Void> pause(@PathVariable Long id) {
        JobEntity job = jobService.findById(id);
        job.setStatus(JobStatusEnum.PAUSE.getValue());
        jobService.update(job);
        quartzManage.pauseJob(id);
        return ApiResultUtil.success();
    }

    @PostMapping("/resume/{id}")
    @ApiOperation(notes = "恢复定时任务", value = "恢复定时任务")
    public ApiResult<Void> resume(@PathVariable Long id) {
        JobEntity job = jobService.findById(id);
        job.setStatus(JobStatusEnum.NORMAL.getValue());
        jobService.update(job);
        quartzManage.resumeJob(id);
        return ApiResultUtil.success();
    }

    @PostMapping("/run/{id}")
    @ApiOperation(notes = "立即执行定时任务", value = "立即执行定时任务")
    public ApiResult<Void> run(@PathVariable Long id) {
        quartzManage.runOnce(id);
        return ApiResultUtil.success();
    }
}
```

---

### 5.3 秒杀活动模块

#### 5.3.1 数据库表结构

```sql
-- 秒杀时间段表
CREATE TABLE `mkt_seckill_time_slot` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '时段名称',
  `start_time` time NOT NULL COMMENT '开始时间',
  `end_time` time NOT NULL COMMENT '结束时间',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-停用，1-启用',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='秒杀时间段表';

-- 秒杀商品表
CREATE TABLE `mkt_seckill_product` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `product_id` bigint NOT NULL COMMENT '商品ID',
  `time_slot_id` bigint NOT NULL COMMENT '时间段ID',
  `original_price` decimal(10,2) NOT NULL COMMENT '原价',
  `seckill_price` decimal(10,2) NOT NULL COMMENT '秒杀价',
  `total_count` int NOT NULL COMMENT '总数量',
  `seckill_count` int DEFAULT 0 COMMENT '已秒杀数量',
  `limit_count` int DEFAULT 1 COMMENT '每人限抢数量',
  `start_time` datetime NOT NULL COMMENT '秒杀开始时间',
  `end_time` datetime NOT NULL COMMENT '秒杀结束时间',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-未开始，1-进行中，2-已结束',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='秒杀商品表';

-- 秒杀记录表
CREATE TABLE `mkt_seckill_order` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `seckill_product_id` bigint NOT NULL COMMENT '秒杀商品ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `product_id` bigint NOT NULL COMMENT '商品ID',
  `order_id` bigint DEFAULT NULL COMMENT '订单ID',
  `status` tinyint DEFAULT 1 COMMENT '状态：1-待支付，2-已支付，3-已取消',
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_product` (`user_id`, `seckill_product_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='秒杀记录表';
```

#### 5.3.2 Service层实现

```java
// SeckillProductService.java
public interface SeckillProductService extends BaseService<SeckillProductConditionEntity, SeckillProductEntity> {

    /**
     * 秒杀商品
     */
    Long seckill(Long productId, Long timeSlotId);

    /**
     * 获取秒杀列表
     */
    List<SeckillProductEntity> getSeckillList();

    /**
     * 获取秒杀商品详情
     */
    SeckillProductEntity getSeckillDetail(Long productId, Long timeSlotId);
}
```

```java
// SeckillProductServiceImpl.java
@Service
@Slf4j
public class SeckillProductServiceImpl extends BaseServiceImpl<SeckillProductConditionEntity, SeckillProductEntity> 
        implements SeckillProductService {

    @Autowired
    private SeckillProductMapper seckillProductMapper;

    @Autowired
    private RedisUtil redisUtil;

    @Autowired
    private TradeService tradeService;

    private static final String SECKILL_STOCK_KEY = "seckill:stock:";

    @Override
    @Lock(name = "seckill_lock")
    @Transactional(rollbackFor = Exception.class)
    public Long seckill(Long productId, Long timeSlotId) {
        Long userId = UserContext.getCurrentUserId();
        
        // 1. 检查秒杀活动
        SeckillProductConditionEntity condition = new SeckillProductConditionEntity();
        condition.setProductId(productId);
        condition.setTimeSlotId(timeSlotId);
        List<SeckillProductEntity> list = seckillProductMapper.searchByCondition(condition);
        
        if (CollectionUtils.isEmpty(list)) {
            throw new BusinessException("秒杀活动不存在");
        }
        
        SeckillProductEntity seckillProduct = list.get(0);
        
        // 2. 检查秒杀时间
        Date now = new Date();
        if (now.before(seckillProduct.getStartTime())) {
            throw new BusinessException("秒杀活动未开始");
        }
        if (now.after(seckillProduct.getEndTime())) {
            throw new BusinessException("秒杀活动已结束");
        }
        
        // 3. 检查库存（使用Redis原子操作）
        String stockKey = SECKILL_STOCK_KEY + seckillProduct.getId();
        Long stock = redisUtil.decr(stockKey, 1);
        if (stock < 0) {
            redisUtil.incr(stockKey, 1);
            throw new BusinessException("商品已抢完");
        }
        
        // 4. 检查用户限抢数量
        int userCount = seckillProductMapper.countByUser(userId, seckillProduct.getId());
        if (userCount >= seckillProduct.getLimitCount()) {
            redisUtil.incr(stockKey, 1);
            throw new BusinessException("超出限抢数量");
        }
        
        try {
            // 5. 创建秒杀订单
            SeckillOrderEntity seckillOrder = new SeckillOrderEntity();
            seckillOrder.setSeckillProductId(seckillProduct.getId());
            seckillOrder.setUserId(userId);
            seckillOrder.setProductId(productId);
            seckillOrder.setStatus(SeckillOrderStatusEnum.PENDING.getValue());
            seckillOrder.setCreateTime(new Date());
            seckillProductMapper.insertSeckillOrder(seckillOrder);
            
            // 6. 更新秒杀库存
            seckillProduct.setSeckillCount(seckillProduct.getSeckillCount() + 1);
            seckillProductMapper.update(seckillProduct);
            
            return seckillOrder.getId();
            
        } catch (Exception e) {
            redisUtil.incr(stockKey, 1);
            throw e;
        }
    }

    @Override
    public List<SeckillProductEntity> getSeckillList() {
        return seckillProductMapper.findActiveList();
    }

    /**
     * 初始化秒杀库存到Redis
     */
    @PostConstruct
    public void initSeckillStock() {
        List<SeckillProductEntity> list = seckillProductMapper.findActiveList();
        for (SeckillProductEntity product : list) {
            String stockKey = SECKILL_STOCK_KEY + product.getId();
            int stock = product.getTotalCount() - product.getSeckillCount();
            redisUtil.set(stockKey, stock);
        }
    }
}
```

#### 5.3.3 前端API调用

```javascript
// seckillProduct.js
import request from '@/utils/request'

export function getPage(params) {
  const data = params
  return request({
    url: '/v1/seckillProduct/searchByPage',
    method: 'post',
    data
  })
}

export function getDetail(id) {
  return request({
    url: 'v1/seckillProduct/findById?id=' + id,
    method: 'get'
  })
}

export function add(data) {
  return request({
    url: 'v1/seckillProduct/insert',
    method: 'post',
    data
  })
}

export function del(ids) {
  return request({
    url: 'v1/seckillProduct/deleteByIds',
    method: 'post',
    data: ids
  })
}

export function edit(data) {
  return request({
    url: 'v1/seckillProduct/update',
    method: 'post',
    data
  })
}

export default { add, edit, del, getDetail, getPage }
```

---

## 六、公共管理模块（P3优先级）

### 6.1 地区管理

```sql
CREATE TABLE `sys_area` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `pid` bigint DEFAULT 0 COMMENT '父级ID',
  `name` varchar(50) NOT NULL COMMENT '地区名称',
  `level` tinyint DEFAULT 1 COMMENT '层级：1-省，2-市，3-区',
  `pinyin` varchar(100) DEFAULT NULL COMMENT '拼音',
  `code` varchar(20) DEFAULT NULL COMMENT '地区编码',
  `is_del` tinyint DEFAULT 0,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='地区表';
```

### 6.2 通知管理

```sql
CREATE TABLE `sys_notify` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `title` varchar(100) NOT NULL COMMENT '通知标题',
  `content` text COMMENT '通知内容',
  `type` tinyint DEFAULT 1 COMMENT '通知类型：1-系统通知，2-订单通知',
  `to_user_id` bigint NOT NULL COMMENT '接收用户ID',
  `is_read` tinyint DEFAULT 0 COMMENT '是否已读：0-未读，1-已读',
  `is_push` tinyint DEFAULT 0 COMMENT '是否推送：0-未推送，1-已推送',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通知表';
```

### 6.3 图片管理

```sql
CREATE TABLE `sys_photo` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(100) DEFAULT NULL COMMENT '图片名称',
  `url` varchar(500) NOT NULL COMMENT '图片地址',
  `size` bigint DEFAULT NULL COMMENT '图片大小',
  `type` tinyint DEFAULT 1 COMMENT '图片类型：1-商品图片，2-品牌图片，3-其他',
  `group_id` bigint DEFAULT NULL COMMENT '图片组ID',
  `is_del` tinyint DEFAULT 0,
  `create_user_id` bigint DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图片表';

CREATE TABLE `sys_photo_group` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '分组名称',
  `type` tinyint DEFAULT 1 COMMENT '分组类型',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图片分组表';
```

### 6.4 邮件服务

```java
// EmailService.java
public interface EmailService {

    /**
     * 发送简单邮件
     */
    void sendSimpleMail(String to, String subject, String content);

    /**
     * 发送HTML邮件
     */
    void sendHtmlMail(String to, String subject, String content);

    /**
     * 发送模板邮件
     */
    void sendTemplateMail(String to, String templateCode, Map<String, Object> params);
}
```

### 6.5 短信服务

```java
// SmsService.java
public interface SmsService {

    /**
     * 发送短信验证码
     */
    void sendSmsCode(String phone, String code);

    /**
     * 发送通知短信
     */
    void sendNotify(String phone, String templateCode, Map<String, String> params);

    /**
     * 验证短信验证码
     */
    boolean verifySmsCode(String phone, String code);
}
```

### 6.6 文件上传

```java
// UploadService.java
public interface UploadService {

    /**
     * 上传文件
     */
    FileDTO upload(MultipartFile file, String folder, String contentType);

    /**
     * 上传图片
     */
    FileDTO uploadImage(MultipartFile file);

    /**
     * 上传商品图片
     */
    FileDTO uploadProductImage(MultipartFile file);

    /**
     * 删除文件
     */
    void delete(String url);
}
```

---

## 七、系统监控模块（P3优先级）

### 7.1 在线用户管理

```sql
CREATE TABLE `sys_online_user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `token` varchar(200) NOT NULL COMMENT '用户Token',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `user_name` varchar(50) NOT NULL COMMENT '用户名',
  `login_time` datetime DEFAULT NULL COMMENT '登录时间',
  `last_active_time` datetime DEFAULT NULL COMMENT '最后活跃时间',
  `ip` varchar(50) DEFAULT NULL COMMENT '登录IP',
  `browser` varchar(50) DEFAULT NULL COMMENT '浏览器',
  `os` varchar(50) DEFAULT NULL COMMENT '操作系统',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_token` (`token`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='在线用户表';
```

### 7.2 操作日志

```sql
CREATE TABLE `sys_log` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint DEFAULT NULL COMMENT '用户ID',
  `username` varchar(50) DEFAULT NULL COMMENT '用户名',
  `operation` varchar(50) DEFAULT NULL COMMENT '操作类型',
  `method` varchar(200) DEFAULT NULL COMMENT '请求方法',
  `params` text COMMENT '请求参数',
  `ip` varchar(50) DEFAULT NULL COMMENT 'IP地址',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-异常，1-正常',
  `time_consuming` int DEFAULT 0 COMMENT '执行耗时(ms)',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='操作日志表';
```

### 7.3 服务监控

```java
// ServerMonitorController.java
@RestController
@RequestMapping("/v1/server")
@Api(tags = "服务器监控")
public class ServerMonitorController {

    @GetMapping("/info")
    @ApiOperation(notes = "获取服务器信息", value = "获取服务器信息")
    public ApiResult<ServerInfo> getServerInfo() {
        ServerInfo info = new ServerInfo();
        
        // CPU信息
        info.setCpu(CpuUtil.getCpuInfo());
        
        // 内存信息
        info.setMemory(MemoryUtil.getMemoryInfo());
        
        // 磁盘信息
        info.setDisk(DiskUtil.getDiskInfo());
        
        // JVM信息
        info.setJvm(JvmUtil.getJvmInfo());
        
        return ApiResultUtil.success(info);
    }
}
```

---

## 八、运维工具模块（P4优先级）

### 8.1 代码生成模块

```sql
-- 代码生成配置表
CREATE TABLE `gen_config` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `table_name` varchar(100) NOT NULL COMMENT '表名',
  `table_comment` varchar(200) DEFAULT NULL COMMENT '表注释',
  `entity_name` varchar(100) NOT NULL COMMENT '实体类名',
  `module_name` varchar(50) NOT NULL COMMENT '模块名',
  `package_name` varchar(100) NOT NULL COMMENT '包名',
  `author` varchar(50) DEFAULT NULL COMMENT '作者',
  `is_remove_prefix` tinyint DEFAULT 1 COMMENT '是否去前缀：0-否，1-是',
  `prefix` varchar(50) DEFAULT NULL COMMENT '表前缀',
  `template_type` tinyint DEFAULT 1 COMMENT '模板类型：1-单表，2-树表',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='代码生成配置表';
```

### 8.2 部署运维模块

```sql
-- 应用表
CREATE TABLE `mnt_app` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '应用名称',
  `port` int DEFAULT 8080 COMMENT '应用端口',
  `deploy_path` varchar(200) DEFAULT NULL COMMENT '部署路径',
  `backup_path` varchar(200) DEFAULT NULL COMMENT '备份路径',
  `start_script` text COMMENT '启动脚本',
  `stop_script` text COMMENT '停止脚本',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='应用表';

-- 服务器表
CREATE TABLE `mnt_server_deploy` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '服务器名称',
  `ip` varchar(50) NOT NULL COMMENT 'IP地址',
  `port` int DEFAULT 22 COMMENT 'SSH端口',
  `username` varchar(50) DEFAULT NULL COMMENT '用户名',
  `password` varchar(100) DEFAULT NULL COMMENT '密码',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务器部署表';

-- 部署表
CREATE TABLE `mnt_deploy` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `app_id` bigint NOT NULL COMMENT '应用ID',
  `server_id` bigint NOT NULL COMMENT '服务器ID',
  `deploy_path` varchar(200) DEFAULT NULL COMMENT '部署路径',
  `status` tinyint DEFAULT 0 COMMENT '状态：0-停止，1-运行中',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部署表';
```

### 8.3 数据源管理

```sql
-- 数据库连接表
CREATE TABLE `mnt_database` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '数据库名称',
  `jdbc_url` varchar(500) NOT NULL COMMENT 'JDBC URL',
  `username` varchar(50) DEFAULT NULL COMMENT '用户名',
  `password` varchar(100) DEFAULT NULL COMMENT '密码',
  `db_type` tinyint DEFAULT 1 COMMENT '数据库类型：1-MySQL，2-PostgreSQL',
  `is_del` tinyint DEFAULT 0,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='数据库连接表';
```

---

## 九、模块实现优先级汇总

| 优先级 | 模块 | 核心功能 |
|--------|------|----------|
| **P0** | 用户认证模块 | 登录、注册、权限、Token |
| **P0** | 商品管理模块 | 商品CRUD、分类、品牌、属性 |
| **P0** | 订单管理模块 | 下单、支付、发货、收货 |
| **P1** | 购物车模块 | 添加购物车、收货地址 |
| **P1** | 优惠券模块 | 优惠券发放、领取、使用 |
| **P1** | 支付模块 | 支付宝集成、退款 |
| **P2** | 售后模块 | 退款申请、审核 |
| **P2** | 定时任务模块 | 任务调度、任务日志 |
| **P2** | 秒杀模块 | 秒杀活动、限时限购 |
| **P3** | 公共管理 | 地区、通知、图片 |
| **P3** | 工具类 | 邮件、短信、上传 |
| **P3** | 系统监控 | 在线用户、操作日志 |
| **P4** | 代码生成 | 表管理、代码生成 |
| **P4** | 部署运维 | 应用管理、服务器管理 |
| **P4** | 数据源管理 | 多数据源管理 |

---

## 十、开发建议

### 10.1 开发顺序

1. **第一阶段（1-2周）**：完成基础架构搭建和核心模块（用户、商品、订单）
2. **第二阶段（1-2周）**：完成业务功能模块（购物车、优惠券、支付）
3. **第三阶段（1周）**：完成业务扩展模块（售后、定时任务、秒杀）
4. **第四阶段（1周）**：完成公共管理和系统监控模块
5. **第五阶段（1周）**：完成运维工具模块

### 10.2 注意事项

1. **安全性**：所有密码必须加密存储，敏感操作需要日志记录
2. **幂等性**：支付、退款等关键操作需要保证幂等性
3. **事务管理**：使用@Transactional注解保证事务
4. **分布式锁**：库存操作需要使用分布式锁防止超卖
5. **限流熔断**：秒杀等高并发场景需要限流和熔断保护
6. **日志追踪**：使用TraceId实现全链路日志追踪

### 10.3 性能优化建议

1. **缓存策略**：热点数据使用Redis缓存
2. **数据库优化**：合理使用索引，分库分表
3. **异步处理**：非核心链路使用消息队列异步处理
4. **CDN加速**：静态资源使用CDN加速
5. **读写分离**：主从复制实现读写分离

---

## 十一、前端API调用汇总

### 认证相关

| 功能 | 方法 | URL | 说明 |
|------|------|-----|------|
| 登录 | POST | /v1/web/user/login | 用户登录 |
| 获取用户信息 | GET | /v1/web/user/info | 获取当前用户信息 |
| 获取验证码 | GET | /v1/web/user/code | 获取验证码图片 |
| 退出登录 | POST | /v1/web/user/logout | 退出登录 |

### 系统管理

| 功能 | 方法 | URL | 说明 |
|------|------|-----|------|
| 分页查询用户 | POST | /v1/user/searchByPage | 分页查询 |
| 查询用户详情 | GET | /v1/user/findById | 根据ID查询 |
| 新增用户 | POST | /v1/user/insert | 新增用户 |
| 修改用户 | POST | /v1/user/update | 修改用户 |
| 删除用户 | POST | /v1/user/deleteByIds | 批量删除 |
| 修改密码 | POST | /v1/user/updatePass | 修改密码 |
| 重置密码 | POST | /v1/user/resetPwd | 重置密码 |
| 导出用户 | POST | /v1/user/export | 导出Excel |

### 商品管理

| 功能 | 方法 | URL | 说明 |
|------|------|-----|------|
| 分页查询商品 | POST | /v1/product/searchByPage | 分页查询 |
| 查询商品详情 | GET | /v1/product/findById | 根据ID查询 |
| 新增商品 | POST | /v1/product/insert | 新增商品 |
| 修改商品 | POST | /v1/product/update | 修改商品 |
| 删除商品 | POST | /v1/product/deleteByIds | 批量删除 |
| 商品上架 | POST | /v1/product/onSale | 上架商品 |
| 商品下架 | POST | /v1/product/offSale | 下架商品 |

### 订单管理

| 功能 | 方法 | URL | 说明 |
|------|------|-----|------|
| 分页查询订单 | POST | /v1/trade/searchByPage | 分页查询 |
| 查询订单详情 | GET | /v1/trade/findById | 根据ID查询 |
| 创建订单 | POST | /v1/trade/insert | 创建订单 |
| 修改订单 | POST | /v1/trade/update | 修改订单 |
| 删除订单 | POST | /v1/trade/deleteByIds | 批量删除 |
| 订单发货 | POST | /v1/trade/shippedByIds | 批量发货 |

### 购物车

| 功能 | 方法 | URL | 说明 |
|------|------|-----|------|
| 分页查询购物车 | POST | /v1/shoppingCart/searchByPage | 分页查询 |
| 添加到购物车 | POST | /v1/shoppingCart/insert | 添加购物车 |
| 修改购物车数量 | POST | /v1/shoppingCart/update | 修改数量 |
| 删除购物车 | POST | /v1/shoppingCart/deleteByIds | 批量删除 |
| 清空购物车 | POST | /v1/shoppingCart/clear | 清空购物车 |

### 优惠券

| 功能 | 方法 | URL | 说明 |
|------|------|-----|------|
| 分页查询优惠券 | POST | /v1/coupon/searchByPage | 分页查询 |
| 查询优惠券详情 | GET | /v1/coupon/findById | 根据ID查询 |
| 新增优惠券 | POST | /v1/coupon/insert | 新增优惠券 |
| 修改优惠券 | POST | /v1/coupon/update | 修改优惠券 |
| 删除优惠券 | POST | /v1/coupon/deleteByIds | 批量删除 |
| 领取优惠券 | POST | /v1/coupon/receive | 领取优惠券 |

### 支付

| 功能 | 方法 | URL | 说明 |
|------|------|-----|------|
| 发起支付宝支付 | POST | /v1/web/pay/aliPay | 发起支付 |
| 支付宝异步通知 | POST | /v1/web/pay/aliPay/notify | 异步回调 |
| 查询支付状态 | GET | /v1/web/pay/query/{payNo} | 查询状态 |
| 申请退款 | POST | /v1/web/pay/refund | 申请退款 |

### 退款

| 功能 | 方法 | URL | 说明 |
|------|------|-----|------|
| 分页查询退款 | POST | /v1/refund/searchByPage | 分页查询 |
| 查询退款详情 | GET | /v1/refund/findById | 根据ID查询 |
| 申请退款 | POST | /v1/refund/insert | 申请退款 |
| 审核退款 | POST | /v1/refund/audit | 审核退款 |
| 删除退款 | POST | /v1/refund/deleteByIds | 批量删除 |

### 定时任务

| 功能 | 方法 | URL | 说明 |
|------|------|-----|------|
| 分页查询任务 | POST | /v1/job/searchByPage | 分页查询 |
| 新增任务 | POST | /v1/job/insert | 新增任务 |
| 修改任务 | POST | /v1/job/update | 修改任务 |
| 删除任务 | POST | /v1/job/deleteByIds | 批量删除 |
| 暂停任务 | POST | /v1/job/pause/{id} | 暂停任务 |
| 恢复任务 | POST | /v1/job/resume/{id} | 恢复任务 |
| 立即执行 | POST | /v1/job/run/{id} | 立即执行 |

### 秒杀

| 功能 | 方法 | URL | 说明 |
|------|------|-----|------|
| 分页查询秒杀商品 | POST | /v1/seckillProduct/searchByPage | 分页查询 |
| 查询秒杀详情 | GET | /v1/seckillProduct/findById | 根据ID查询 |
| 新增秒杀商品 | POST | /v1/seckillProduct/insert | 新增商品 |
| 修改秒杀商品 | POST | /v1/seckillProduct/update | 修改商品 |
| 删除秒杀商品 | POST | /v1/seckillProduct/deleteByIds | 批量删除 |
| 秒杀商品 | POST | /v1/seckillProduct/seckill | 参与秒杀 |

---

> 文档版本：1.0  
> 最后更新：2025年1月